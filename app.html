<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VivaMente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* [O CSS (style) permanece o mesmo, está oculto aqui por brevidade] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        .container { flex: 1; width: 100%; max-width: 480px; margin: 0 auto; background: linear-gradient(180deg, #4169E1 0%, #1E3A8A 40%); display: flex; flex-direction: column; min-height: 100vh; }
        .header { padding: 20px; color: white; position: relative; }
        .time { font-size: 72px; font-weight: 300; margin-bottom: 5px; letter-spacing: -2px; }
        .date { font-size: 20px; font-weight: 300; opacity: 0.95; margin-bottom: 20px; white-space: nowrap; }
        .app-icon { position: absolute; top: 30px; right: 20px; width: 80px; height: 80px; background: url('https://gvrnnfzflefecxqedgih.supabase.co/storage/v1/object/public/public-assets/icone.png') no-repeat center; background-size: contain; border-radius: 20px; }
        .title-bar { background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 20px; margin: 0 20px; backdrop-filter: blur(10px); }
        .title { font-size: 24px; font-weight: 800; color: white; text-align: center; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: -0.5px; white-space: nowrap; }
        .greeting { font-size: 26px; text-align: center; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .main-content { flex: 1; background: #f0f4f8; border-radius: 30px 30px 0 0; margin-top: 20px; padding: 30px 20px 100px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-content: start; overflow-y: auto; }
        .card { background: white; border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; min-height: 200px; position: relative; overflow: hidden; }
        .card:active { transform: scale(0.98); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .card.locked { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; }
        .card.locked::after { content: '🔒'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; background: rgba(255,255,255,0.7); border-radius: 50%; padding: 10px; backdrop-filter: blur(2px); }
        .card-image { width: 100%; height: 140px; background-size: contain; background-position: center; background-repeat: no-repeat; border-radius: 12px; margin-bottom: 12px; }
        .card-title { font-size: 18px; font-weight: 600; color: #2c3e50; text-align: center; font-family: 'Montserrat', sans-serif; }
        .back-button { grid-column: 1/-1; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 20px; }
        .back-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .module-title { grid-column: 1/-1; text-align: center; font-size: 24px; font-weight: 700; color: #333; margin-bottom: 20px; }
        .feed-container { grid-column: 1/-1; display: flex; flex-direction: column; gap: 20px; }
        .feed-post { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .feed-post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .feed-author-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; flex-shrink: 0; }
        .feed-author-info { flex: 1; }
        .feed-author-name { font-weight: 700; color: #333; font-size: 16px; }
        .feed-post-time { font-size: 12px; color: #999; }
        .feed-post-content { color: #666; line-height: 1.6; margin-top: 10px; }
        .feed-post-image { width: 100%; border-radius: 10px; margin-top: 15px; }
        .community-container { grid-column: 1/-1; display: flex; flex-direction: column; gap: 15px; }
        .community-input-box { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .community-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: 'Montserrat', sans-serif; resize: vertical; min-height: 80px; }
        .community-submit-btn { margin-top: 10px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .community-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .community-message { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .community-message-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .community-avatar { width: 35px; height: 35px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; overflow: hidden;  }
        .community-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .community-author { flex: 1; font-weight: 600; color: #333; }
        .community-time { font-size: 12px; color: #999; }
        .community-text { color: #666; line-height: 1.5; }
        .profile-container { grid-column: 1/-1; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .profile-header { text-align: center; margin-bottom: 15px; }
        .profile-tip { text-align: center; font-size: 14px; color: #666; margin-bottom: 30px; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; position: relative; cursor: pointer; overflow: hidden; }
        .profile-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .profile-avatar-edit { position: absolute; bottom: 0; right: 0; background: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; opacity: 0; transition: opacity 0.3s ease; }
        .profile-avatar:hover .profile-avatar-edit { opacity: 1; }
        .profile-form { display: flex; flex-direction: column; gap: 15px; }
        .profile-input { padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: 'Montserrat', sans-serif; font-size: 16px; }
        .profile-save-btn { padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 16px; }
        .logout-btn { margin-top: 20px; padding: 12px 30px; background: #e74c3c; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 480px; margin: 0 auto; background: linear-gradient(180deg, #1a237e 0%, #0d47a1 100%); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 20px; color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: all 0.3s ease; cursor: pointer; flex: 1; }
        .nav-item.active { color: white; background: rgba(255, 255, 255, 0.15); border-radius: 10px; margin: 0 5px; }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        .loading { grid-column: 1/-1; text-align: center; padding: 40px 20px; color: #666; font-size: 16px; display: none; }
        .loading.active { display: block; }
        .empty-state { grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #999; font-size: 18px; }
        .content-player { grid-column: 1/-1; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .content-player h2 { font-size: 26px; font-weight: 700; color: #333; margin-bottom: 20px; text-align: center; }
        .content-player video { width: 100%; border-radius: 12px; margin-bottom: 20px; }
        .content-player audio { width: 100%; margin-bottom: 20px; }
        .content-player img { width: 100%; border-radius: 12px; margin-bottom: 20px; }
        .content-player p { color: #666; line-height: 1.8; font-size: 16px; }
        .content-player .content-description { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .back-to-list { margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="app-icon"></div>
            <div class="time" id="time">00:00</div>
            <div class="date" id="date">Segunda-feira, 1 de Janeiro</div>
        </header>
        <div class="title-bar">
            <h1 class="title" id="pageTitle">Viva Mente</h1>
            <div class="greeting" id="greeting">👋 Olá, Utilizador</div>
        </div>
        <main class="main-content" id="mainContent">
            <div class="loading active">A carregar...</div>
        </main>
        <nav class="nav-bar">
            <div class="nav-item active" data-nav="home" onclick="handleNavClick('home')">
                <div class="nav-icon">🏠</div>
                <div class="nav-label">Início</div>
            </div>
            <div class="nav-item" data-nav="feed" onclick="handleNavClick('feed')">
                <div class="nav-icon">📰</div>
                <div class="nav-label">Feed</div>
            </div>
            <div class="nav-item" data-nav="community" onclick="handleNavClick('community')">
                <div class="nav-icon">💬</div>
                <div class="nav-label">Comunidade</div>
            </div>
            <div class="nav-item" data-nav="profile" onclick="handleNavClick('profile')">
                <div class="nav-icon">👤</div>
                <div class="nav-label">Perfil</div>
            </div>
        </nav>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://gvrnnfzflefecxqedgih.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cm5uZnpmbGVmZWN4cWVkZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2Njc4MDgsImV4cCI6MjA1MTI0MzgwOH0.zDlBuhNHpvYsCWX0XmpCZIJPjjq6Cp8H0_W7AHBCrXw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = { isPremium: false, purchasedProducts: [] };
        let modules = [];
        let subModules = [];
        let contents = [];
        let modulesMap = new Map();
        let subModulesMap = new Map();
        let contentsMap = new Map();
        let profilesMap = new Map();
        let currentAudio = null;

        const PREMIUM_PRODUCT_ID = 'mackvtut';
        let productsData = [];

        // Função para verificar se usuário tem acesso a um módulo
        function userHasAccessToModule(moduleKey) {
            // Premium tem acesso a tudo
            if (currentUser.isPremium) return true;
            
            // Buscar quais produtos incluem este módulo
            const productsWithModule = productsData.filter(p => 
                p.module_keys && p.module_keys.includes(moduleKey)
            );
            
            // Verificar se o usuário tem ALGUM desses produtos
            return productsWithModule.some(product => 
                currentUser.purchasedProducts && currentUser.purchasedProducts.includes(product.id)
            );
        }

        async function init() {
            await checkAuth();
            updateTime();
            setInterval(updateTime, 1000);
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading active">A carregar...</div>';
            try {
                const [profileRes, authorizedUserRes, modulesRes, subModulesRes, allProfilesRes, contentsRes, productsRes] = await Promise.all([
                    supabase.from('profiles').select('*').eq('id', currentUser.id).single(),
                    supabase.from('authorized_users').select('*').eq('email', currentUser.email).single(),
                    supabase.from('modules').select('*').eq('active', true).order('position', { ascending: true }),
                    supabase.from('sub_modules').select('*').eq('active', true).order('position', { ascending: true }),
                    supabase.from('profiles').select('id, name, avatar_url'),
                    supabase.from('contents').select('*').eq('active', true).order('position', { ascending: true }),
                    supabase.from('products').select('id, name, module_keys, duration_days')
                ]);
                
                // Guardar produtos
                productsData = productsRes.data || [];
                console.log('Produtos carregados:', productsData.length);
                
                currentUser.profile = profileRes.data || {};
                modules = modulesRes.data || [];
                subModules = subModulesRes.data || [];
                contents = contentsRes.data || [];
                const allProfiles = allProfilesRes.data || [];
                allProfiles.forEach(p => profilesMap.set(p.id, p));
                modules.forEach(m => modulesMap.set(m.key, m));
                subModules.forEach(sm => subModulesMap.set(sm.id, sm));
                contents.forEach(c => contentsMap.set(c.id, c));
                currentUser.isPremium = !!(authorizedUserRes.data && authorizedUserRes.data.product_id === PREMIUM_PRODUCT_ID);
                currentUser.purchasedProducts = (authorizedUserRes.data && authorizedUserRes.data.products) || [];
                updateGreeting();
                if (window.location.hash) handleHashChange();
                else loadHomeModules(false);
                window.addEventListener('popstate', handleHashChange);
            } catch (error) { mainContent.innerHTML = `<div class="empty-state">Erro ao carregar os dados. <br><small>${error.message}</small></div>`; console.error(error); }
        }

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = `${window.location.origin}/index.html`; return; }
            currentUser.id = session.user.id;
            currentUser.email = session.user.email;
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('time').textContent = timeStr;
            const dateStr = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('date').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        }

        function updateGreeting() {
            const name = currentUser.profile?.name || currentUser.email.split('@')[0];
            document.getElementById('greeting').innerHTML = `👋 Olá, ${name}`;
        }

        function setActiveNav(navId) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItem = document.querySelector(`[data-nav="${navId}"]`);
            if (navItem) navItem.classList.add('active');
        }

        function handleNavClick(section) {
            if (section === 'home') loadHomeModules();
            else if (section === 'feed') loadFeed();
            else if (section === 'community') loadCommunity();
            else if (section === 'profile') loadProfile();
        }

        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (!hash) return loadHomeModules(false);
            const [view, id] = hash.split('/');
            if (view === 'feed') loadFeed(false);
            else if (view === 'community') loadCommunity(false);
            else if (view === 'profile') loadProfile(false);
            else if (view === 'sub-modules') loadSubModules(id, false);
            else if (view === 'content-list') loadModuleContents(parseInt(id), false);
            else if (view === 'content') openContent(parseInt(id), false);
            else loadHomeModules(false);
        }

        function loadHomeModules(push = true) {
            if (push && (history.state?.view !== 'home')) history.pushState({ view: 'home' }, '', '#home');
            setActiveNav('home');
            const mainContent = document.getElementById('mainContent');
            document.getElementById('pageTitle').textContent = 'Viva Mente';
            mainContent.innerHTML = '';
            modules.forEach(mod => {
                const hasAccess = userHasAccessToModule(mod.key);
                const card = document.createElement('div');
                card.className = `card ${!hasAccess ? 'locked' : ''}`;
                card.innerHTML = `<div class="card-image" style="background-image: url('${mod.image_url || 'https://placehold.co/200x140/e0e0e0/333?text=Img'}');"></div><span class="card-title">${mod.name}</span>`;
                if (hasAccess) card.onclick = () => loadSubModules(mod.key);
                else card.onclick = () => alert('Você precisa adquirir este módulo para poder acessá-lo.');
                mainContent.appendChild(card);
            });
        }

        async function loadSubModules(moduleKey, push = true) {
            if (push) history.pushState({ view: 'sub-modules', id: moduleKey }, '', `#sub-modules/${moduleKey}`);
            setActiveNav('home');
            const module = modulesMap.get(moduleKey);
            if (!module) return;
            const parentModule = module;
            document.getElementById('pageTitle').textContent = module.name;
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<button class="back-button" onclick="history.back()">← Voltar</button>';
            const filteredSubModules = subModules.filter(sm => sm.module_key === moduleKey);
            filteredSubModules.forEach(sm => {
                subModulesMap.set(sm.id, sm);
                const hasAccess = userHasAccessToModule(parentModule.key);
                const card = document.createElement('div');
                card.className = `card ${!hasAccess ? 'locked' : ''}`;
                card.innerHTML = `<div class="card-image" style="background-image: url('${sm.image_url || 'https://placehold.co/200x140/e0e0e0/333?text=Img'}');"></div><span class="card-title">${sm.name}</span>`;
                if (hasAccess) {
                    card.onclick = () => loadModuleContents(sm.id);
                } else {
                    card.onclick = () => alert('Você precisa adquirir este módulo para poder acessá-lo.');
                }
                mainContent.appendChild(card);
            });
        }

        async function loadModuleContents(subModuleId, push = true) {
            if (push) history.pushState({ view: 'contentList', id: subModuleId }, '', `#content-list/${subModuleId}`);
            
            // Verificar acesso ao módulo
            const subModule = subModulesMap.get(subModuleId);
            if (subModule) {
                const parentModule = modulesMap.get(subModule.module_key);
                if (parentModule) {
                    const hasAccess = userHasAccessToModule(parentModule.key);
                    if (!hasAccess) {
                        alert('Você não tem acesso a este conteúdo. Adquira o módulo para continuar.');
                        history.back();
                        return;
                    }
                }
            }
            
            setActiveNav('home');
            const sm = subModulesMap.get(subModuleId);
            document.getElementById('pageTitle').textContent = sm ? sm.name : 'Conteúdos';
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<button class="back-button" onclick="history.back()">← Voltar</button>';
            const filteredContents = contents.filter(c => c.sub_module_id === subModuleId);
            if (filteredContents.length === 0) mainContent.innerHTML += '<div class="empty-state">Nenhum conteúdo disponível neste módulo.</div>';
            else filteredContents.forEach(content => { contentsMap.set(content.id, content); const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<div class="card-image" style="background-image: url('${content.image_url || 'https://placehold.co/200x140/e0e0e0/333?text=Img'}');"></div><span class="card-title">${content.name}</span>`; card.onclick = () => openContent(content.id); mainContent.appendChild(card); });
        }

        async function openContent(contentId, push = true) {
            if (push) history.pushState({ view: 'content', id: contentId }, '', `#content/${contentId}`);
            setActiveNav('home');
            const content = contentsMap.get(contentId);
            if (!content) return;
            document.getElementById('pageTitle').textContent = content.name;
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `<div class="content-player"><h2>${content.name}</h2>${content.description ? `<div class="content-description">${content.description}</div>` : ''}${getContentMedia(content)}<button class="back-to-list" onclick="goBackFromPlayer()">← Voltar à Lista</button></div>`;
        }

        function getContentMedia(content) {
            if (!content.type || !content.url) return '<p style="color: #999; text-align: center;">Nenhum conteúdo disponível.</p>';
            if (content.type === 'video') return `<video controls controlsList="nodownload" oncontextmenu="return false;"><source src="${content.url}" type="video/mp4">Seu navegador não suporta vídeo.</video>`;
            if (content.type === 'audio') return `<audio controls controlsList="nodownload" oncontextmenu="return false;" onplay="handleAudioPlay(this)"><source src="${content.url}" type="audio/mpeg">Seu navegador não suporta áudio.</audio>`;
            if (content.type === 'image') return `<img src="${content.url}" alt="${content.name}">`;
            if (content.type === 'text') return `<p>${content.text_content || 'Sem conteúdo de texto disponível.'}</p>`;
            return '<p style="color: #999; text-align: center;">Tipo de conteúdo desconhecido.</p>';
        }

        function handleAudioPlay(audioElement) {
            if (currentAudio && currentAudio !== audioElement) currentAudio.pause();
            currentAudio = audioElement;
        }

        function goBackFromPlayer() {
            history.back();
        }

        async function loadFeed(push = true) {
            if (push && (history.state?.view !== 'feed')) history.pushState({ view: 'feed' }, '', '#feed');
            setActiveNav('feed');
            document.getElementById('pageTitle').textContent = 'Feed';
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading active">A carregar o feed...</div>';
            const { data, error } = await supabase.from('feed_posts').select('*').eq('active', true).order('created_at', { ascending: false });
            if (error) return mainContent.innerHTML = `<div class="empty-state">Erro ao carregar o feed. <br><small>${error.message}</small></div>`;
            if (!data || data.length === 0) return mainContent.innerHTML = '<div class="empty-state">Nenhuma postagem no feed ainda.</div>';
            mainContent.innerHTML = '<div class="feed-container"></div>';
            mainContent.querySelector('.feed-container').innerHTML = data.map(post => `<div class="feed-post"><div class="feed-post-header"><div class="feed-author-avatar">🛡️</div><div class="feed-author-info"><div class="feed-author-name">${post.title}</div><div class="feed-post-time">${new Date(post.created_at).toLocaleDateString('pt-BR')}</div></div></div><div class="feed-post-content">${post.content}</div>${post.image_url ? `<img src="${post.image_url}" class="feed-post-image">` : ''}</div>`).join('');
        }

        async function loadCommunity(push = true) {
            if (push && (history.state?.view !== 'community')) history.pushState({ view: 'community' }, '', '#community');
            setActiveNav('community');
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `<div class="community-container"><div class="community-input-box"><textarea class="community-input" id="communityMessage" placeholder="Partilhe a sua experiência..."></textarea><button class="community-submit-btn" onclick="sendCommunityMessage()">Enviar Mensagem</button><p style="font-size: 12px; color: #999; margin-top: 10px;">* As mensagens serão revistas antes de aparecerem</p></div><div id="communityMessagesList"><div class="loading active">A carregar mensagens...</div></div></div>`;
            const { data, error } = await supabase.from('community_posts').select('*').eq('status', 'approved').order('created_at', { ascending: false });
            const messagesListEl = document.getElementById('communityMessagesList');
            if (error) return messagesListEl.innerHTML = `<div class="empty-state">Erro ao carregar as mensagens. <br><small>${error.message}</small></div>`;
            if (!data || data.length === 0) return messagesListEl.innerHTML = '<div class="empty-state">Seja o primeiro a partilhar!</div>';
            messagesListEl.innerHTML = data.map(msg => { const author = profilesMap.get(msg.user_id) || { name: 'Anónimo', avatar_url: null }; return `<div class="community-message"><div class="community-message-header"><div class="community-avatar">${author.avatar_url ? `<img src="${author.avatar_url}" alt="${author.name}">` : author.name.charAt(0).toUpperCase()}</div><div class="community-author">${author.name}</div><div class="community-time">${new Date(msg.created_at).toLocaleDateString('pt-BR')}</div></div><div class="community-text">${msg.content}</div></div>`; }).join('');
        }

        async function sendCommunityMessage() {
            const messageInput = document.getElementById('communityMessage');
            const message = messageInput.value.trim();
            if (!message) return alert('Por favor, escreva uma mensagem.');
            const { error } = await supabase.from('community_posts').insert([{ user_id: currentUser.id, content: message, status: 'pending' }]);
            if (error) alert(`Erro ao enviar mensagem: ${error.message}`);
            else { alert('Mensagem enviada! Aguarde a aprovação.'); messageInput.value = ''; }
        }

        function loadProfile(push = true) {
            if (push && (history.state?.view !== 'profile')) history.pushState({ view: 'profile' }, '', '#profile');
            setActiveNav('profile');
            const mainContent = document.getElementById('mainContent');
            const profile = currentUser.profile || {};
            const initial = (profile.name || currentUser.email || 'U').charAt(0).toUpperCase();
            mainContent.innerHTML = `<div class="profile-container"><div class="profile-header"><h2 class="module-title" style="margin-bottom: 20px;">Seu Perfil</h2><div class="profile-avatar" onclick="document.getElementById('avatarFile').click()">${profile.avatar_url ? `<img src="${profile.avatar_url}" alt="Avatar">` : initial}<div class="profile-avatar-edit">📷</div><input type="file" id="avatarFile" accept="image/*" style="display: none;" onchange="uploadAvatar(event)"></div><p class="profile-tip">Clique no ícone para alterar a sua foto</p></div><div class="profile-form"><label for="profileName">Nome</label><input type="text" class="profile-input" id="profileName" placeholder="O seu nome" value="${profile.name || ''}"><label for="profileEmail">Email (não pode ser alterado)</label><input type="email" class="profile-input" id="profileEmail" value="${currentUser.email}" disabled><button class="profile-save-btn" onclick="saveProfile()">Guardar Alterações</button></div><button class="logout-btn" onclick="logout()">Sair do App</button></div>`;
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            if (!name) return alert('O nome não pode ficar em branco.');
            const { error } = await supabase.from('profiles').update({ name: name, updated_at: new Date() }).eq('id', currentUser.id);
            if (error) alert(`Erro ao atualizar o perfil: ${error.message}`);
            else { alert('Perfil atualizado com sucesso!'); currentUser.profile.name = name; profilesMap.set(currentUser.id, { ...profilesMap.get(currentUser.id), name: name }); updateGreeting(); loadProfile(false); }
        }

        async function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            const filePath = `${currentUser.id}/${Date.now()}.${file.name.split('.').pop()}`;
            let { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });
            if (uploadError) return alert(`Erro ao carregar a imagem: ${uploadError.message}`);
            const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
            let { error: updateError } = await supabase.from('profiles').update({ avatar_url: data.publicUrl, updated_at: new Date() }).eq('id', currentUser.id);
            if (updateError) alert(`Erro ao guardar a URL do avatar: ${updateError.message}`);
            else { currentUser.profile.avatar_url = data.publicUrl; profilesMap.set(currentUser.id, { ...profilesMap.get(currentUser.id), avatar_url: data.publicUrl }); loadProfile(false); }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = `${window.location.origin}/index.html`;
        }

        Object.assign(window, { handleNavClick, loadModuleContents, openContent, sendCommunityMessage, logout, saveProfile, uploadAvatar, goBackFromPlayer, loadSubModules });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
