<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VivaMente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* [O CSS (style) permanece o mesmo, está oculto aqui por brevidade] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        .container { flex: 1; width: 100%; max-width: 480px; margin: 0 auto; background: linear-gradient(180deg, #4169E1 0%, #1E3A8A 40%); display: flex; flex-direction: column; min-height: 100vh; }
        .header { padding: 20px; color: white; position: relative; }
        .time { font-size: 72px; font-weight: 300; margin-bottom: 5px; letter-spacing: -2px; }
        .date { font-size: 20px; font-weight: 300; opacity: 0.95; margin-bottom: 20px; white-space: nowrap; }
        .app-icon { position: absolute; top: 30px; right: 20px; width: 80px; height: 80px; background: url('https://gvrnnfzflefecxqedgih.supabase.co/storage/v1/object/public/public-assets/icone.png') no-repeat center; background-size: contain; border-radius: 20px; }
        .title-bar { background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 20px; margin: 0 20px; backdrop-filter: blur(10px); }
        .title { font-size: 24px; font-weight: 800; color: white; text-align: center; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: -0.5px; white-space: nowrap; }
        .greeting { font-size: 26px; text-align: center; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .main-content { flex: 1; background: #f0f4f8; border-radius: 30px 30px 0 0; margin-top: 20px; padding: 30px 20px 100px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-content: start; overflow-y: auto; }
        .card { background: white; border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; min-height: 200px; position: relative; overflow: hidden; }
        .card:active { transform: scale(0.98); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .card.locked { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; }
        .card.locked::after { content: '🔒'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; background: rgba(255,255,255,0.7); border-radius: 50%; padding: 10px; backdrop-filter: blur(2px); }
        .card-image { width: 100%; height: 140px; background-size: contain; background-position: center; background-repeat: no-repeat; border-radius: 12px; margin-bottom: 12px; }
        .card-title { font-size: 18px; font-weight: 600; color: #2c3e50; text-align: center; font-family: 'Montserrat', sans-serif; }
        .back-button { grid-column: 1/-1; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 20px; }
        .back-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .module-title { grid-column: 1/-1; text-align: center; font-size: 24px; font-weight: 700; color: #333; margin-bottom: 20px; }
        .feed-container { grid-column: 1/-1; display: flex; flex-direction: column; gap: 20px; }
        .feed-post { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .feed-post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .feed-author-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; flex-shrink: 0; }
        .feed-author-info { flex: 1; }
        .feed-author-name { font-weight: 700; color: #333; font-size: 16px; }
        .feed-post-time { font-size: 12px; color: #999; }
        .feed-post-content { color: #666; line-height: 1.6; margin-top: 10px; }
        .feed-post-image { width: 100%; border-radius: 10px; margin-top: 15px; }
        .community-container { grid-column: 1/-1; display: flex; flex-direction: column; gap: 15px; }
        .community-input-box { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .community-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: 'Montserrat', sans-serif; resize: vertical; min-height: 80px; }
        .community-submit-btn { margin-top: 10px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .community-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .community-message { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .community-message-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .community-avatar { width: 35px; height: 35px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; overflow: hidden;  }
        .community-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .community-author { flex: 1; font-weight: 600; color: #333; }
        .community-time { font-size: 12px; color: #999; }
        .community-text { color: #666; line-height: 1.5; }
        .profile-container { grid-column: 1/-1; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .profile-header { text-align: center; margin-bottom: 15px; }
        .profile-tip { text-align: center; font-size: 14px; color: #666; margin-bottom: 30px; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; position: relative; cursor: pointer; overflow: hidden; }
        .profile-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .profile-avatar-edit { position: absolute; bottom: 0; right: 0; background: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; opacity: 0; transition: opacity 0.3s ease; }
        .profile-avatar:hover .profile-avatar-edit { opacity: 1; }
        .profile-form { display: flex; flex-direction: column; gap: 15px; }
        .profile-input { padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: 'Montserrat', sans-serif; font-size: 16px; }
        .profile-save-btn { padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 16px; }
        .logout-btn { margin-top: 20px; padding: 12px 30px; background: #e74c3c; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 480px; margin: 0 auto; background: linear-gradient(180deg, #1a237e 0%, #0d47a1 100%); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 20px; color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: all 0.3s ease; cursor: pointer; flex: 1; }
        .nav-item.active { color: white; background: rgba(255, 255, 255, 0.15); border-radius: 10px; margin: 0 5px; }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        .loading, .empty-state { grid-column: 1/-1; text-align: center; padding: 40px; color: #666; }
        .iframe-container { grid-column: 1/-1; background: white; border-radius: 15px; padding: 10px; height: calc(100vh - 250px); min-height: 500px; overflow: auto; position: relative; }
        .audio-player-view { grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; padding: 20px 0; height: calc(100vh - 220px); justify-content: center; }
        .player-art { width: 220px; height: 220px; border-radius: 50%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; border: 5px solid white; }
        .player-art-image { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .player-info { text-align: center; margin-top: 40px; }
        .player-title { font-size: 28px; font-weight: 700; color: #333; }
        .player-progress-container { width: 100%; max-width: 350px; margin-top: 40px; }
        .progress-time { display: flex; justify-content: space-between; font-size: 14px; color: #555; margin-bottom: 5px; font-weight: 500; }
        .progress-bar { width: 100%; -webkit-appearance: none; appearance: none; height: 8px; background: #ddd; border-radius: 5px; outline: none; cursor: pointer; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #4169E1; border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 40px; margin-top: 30px; }
        .control-btn { background: none; border: none; cursor: pointer; font-size: 32px; color: #333; }
        .play-pause-btn { font-size: 60px; color: #4169E1; width: 70px; height: 70px; background: white; border-radius: 50%; box-shadow: 0 5px 15px rgba(65, 105, 225, 0.3); display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="mainHeader">
            <div class="time" id="time">00:00</div>
            <div class="date" id="date">A carregar...</div>
            <div class="app-icon"></div>
        </div>
        
        <div class="title-bar" id="titleBar">
            <h1 class="title">VivaMente</h1>
            <div class="greeting" id="greeting">Olá!</div>
        </div>
        
        <div class="main-content" id="mainContent"></div>
        
        <nav class="nav-bar">
            <div class="nav-item active" onclick="handleNavClick('home')" data-nav="home"><span class="nav-icon">🏠</span><span class="nav-label">INÍCIO</span></div>
            <div class="nav-item" onclick="handleNavClick('feed')" data-nav="feed"><span class="nav-icon">📋</span><span class="nav-label">Feed</span></div>
            <div class="nav-item" onclick="handleNavClick('community')" data-nav="community"><span class="nav-icon">💬</span><span class="nav-label">Comunidade</span></div>
            <div class="nav-item" onclick="handleNavClick('profile')" data-nav="profile"><span class="nav-icon">👤</span><span class="nav-label">Perfil</span></div>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://gvrnnfzflefecxqedgih.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cm5uZnpmbGVmZWN4cWVkZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NjE3MzIsImV4cCI6MjA3NDEzNzczMn0.kmvAFT7qlExTk2JQf5NjLB0sfwKaqb8RfxvdCbl8oXo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let modulesMap = new Map();
        let subModulesMap = new Map();
        let contentsMap = new Map();
        let profilesMap = new Map();
        let currentAudio = null;
        
        const PREMIUM_PRODUCT_ID = 'mackvtut'; 

        
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = `${window.location.origin}/index.html`;
                return;
            }
            currentUser = session.user;

            // --- ESTA É A MUDANÇA (v8) ---
            // Revertemos para buscar por 'user_id' (currentUser.id), 
            // que é o método correto e seguro após a vinculação no index.html.
            const [profileRes, authorizedUserRes, allProfilesRes, contentsRes] = await Promise.all([
                supabase.from('profiles').select('*').eq('id', currentUser.id).single(),
                supabase.from('authorized_users').select('*').eq('user_id', currentUser.id).single(),
                supabase.from('profiles').select('id, name, email, avatar_url'),
                supabase.from('contents').select('*').eq('active', true)
            ]);
            // --- FIM DA MUDANÇA ---


            if (profileRes.error) {
                console.error("Erro ao carregar perfil:", profileRes.error);
                document.body.innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: Arial;">
                        <h2>⚠️ Erro ao carregar perfil</h2>
                        <p>Por favor, contacte o suporte.</p>
                        <button onclick="logout()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">
                            Sair
                        </button>
                    </div>
                `;
                return;
            }
            
            // Erro PGRST116 = "0 rows" (sem correspondência), o que significa que não é autorizado
            if (authorizedUserRes.error && authorizedUserRes.error.code !== 'PGRST116') {
                console.error("Erro ao carregar dados de autorização:", authorizedUserRes.error);
                document.body.innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: Arial;">
                        <h2>⚠️ Acesso não autorizado</h2>
                        <p>Use o email registrado na compra.</p>
                        <button onclick="logout()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">
                            Voltar ao Login
                        </button>
                    </div>
                `;
                return;
            }

            currentUser.profile = profileRes.data || {};
                
            const authUser = authorizedUserRes.data;
            if (authUser) {
                currentUser.purchasedProducts = authUser.purchased_products || [];
                currentUser.subscriptionExpiresAt = authUser.expires_at;
                currentUser.subscriptionType = authUser.subscription_type;
                        
                if (currentUser.subscriptionExpiresAt) {
                    const expirationDate = new Date(currentUser.subscriptionExpiresAt);
                    const now = new Date();
                                
                    if (expirationDate < now) {
                        showExpirationModal();
                        return;
                    }
                                
                    const daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
                    currentUser.daysRemaining = daysRemaining;
                                
                    if (daysRemaining <= 7 && daysRemaining > 0) {
                        showExpirationWarning(daysRemaining);
                    }
                }
                        
                currentUser.isPremium = currentUser.purchasedProducts.some(p => 
                    p.toLowerCase().includes('premium') || p.includes(PREMIUM_PRODUCT_ID)
                ) || authUser.subscription_type === 'lifetime';
            
            } else {
                // Usuário não tem compra registrada (PGRST116 ou authUser é nulo)
                document.body.innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: Arial;">
                        <h2>🔒 Acesso Restrito</h2>
                        <p>Você precisa adquirir o VivaMente para acessar.</p>
                        <p style="margin-top: 20px;">
                            <a href="https://pay.hotmart.com/O102665956S?off=mackvtut"
                                style="padding: 15px 30px; background: #4169E1; color: white;
                                       text-decoration: none; border-radius: 10px; display: inline-block;">
                                Adquirir Agora
                            </a>
                        </p>
                        <button onclick="logout()" 
                                style="padding: 10px 20px; margin-top: 20px; cursor: pointer;
                                        background: #e0e0e0; border: none; border-radius: 5px;">
                            Sair
                        </button>
                    </div>
                `;
                return;
            }

            if(allProfilesRes.data) allProfilesRes.data.forEach(p => profilesMap.set(p.id, { name: p.name || p.email.split('@')[0], avatar_url: p.avatar_url }));
            if(contentsRes.data) contentsRes.data.forEach(c => contentsMap.set(c.id, c));

            updateTime();
            updateDate();
            updateGreeting();
            history.replaceState({ view: 'home' }, '', '#home');
            loadHomeModules(false);
            window.addEventListener('popstate', handlePopState);
            setInterval(updateTime, 60000);
        }

        // --- FUNÇÕES DE AJUDA ---
        function showExpirationModal() {
            alert("A sua assinatura expirou. Por favor, renove para continuar a aceder.");
            logout();
        }

        function showExpirationWarning(daysRemaining) {
            alert(`Aviso: A sua assinatura expira em ${daysRemaining} dias.`);
        }
        
        function updateTime() { document.getElementById('time').textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); }
        function updateDate() { document.getElementById('date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = hour < 12 ? '🌅 Bom Dia' : hour < 18 ? '☀️ Boa Tarde' : '🌙 Boa Noite';
            const name = currentUser.profile.name ? currentUser.profile.name.split(' ')[0] : 'Utilizador';
            document.getElementById('greeting').innerHTML = `${greeting}, ${name}!`;
        }

        function handlePopState(event) {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            if (event.state) {
                const state = event.state;
                switch(state.view) {
                    case 'home': setActiveNav('home'); loadHomeModules(false); break;
                    case 'feed': setActiveNav('feed'); loadFeed(false); break;
                    case 'community': setActiveNav('community'); loadCommunity(false); break;
                    case 'profile': setActiveNav('profile'); loadProfile(false); break;
                    case 'subModule': setActiveNav('home'); loadSubModules(state.key, false); break;
                    case 'contentList': setActiveNav('home'); loadModuleContents(state.id, false); break;
                    case 'content': setActiveNav('home'); openContent(state.id, false); break;
                    default: setActiveNav('home'); loadHomeModules(false);
                }
            } else {
                setActiveNav('home');
                loadHomeModules(false);
            }
        }

        function setActiveNav(view) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.nav === view));
            const isHomeScreen = ['home', 'subModule', 'contentList', 'content'].includes(view);
            document.getElementById('mainHeader').style.display = isHomeScreen ? 'block' : 'none';
            document.getElementById('titleBar').style.display = isHomeScreen ? 'block' : 'none';
        }

        function handleNavClick(view) {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            const currentState = history.state || { view: 'home' };
            if (view === 'home' && ['subModule', 'contentList', 'content'].includes(currentState.view)) {}
            else if (currentState.view === view) return;
            switch(view) {
                case 'home': loadHomeModules(); break;
                case 'feed': loadFeed(); break;
                case 'community': loadCommunity(); break;
                case 'profile': loadProfile(); break;
            }
        }

        async function loadHomeModules(push = true) {
            if (push && (history.state?.view !== 'home')) history.pushState({ view: 'home' }, '', '#home');
            setActiveNav('home');

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading active">A carregar módulos...</div>';

            const { data: modules, error } = await supabase.from('modules').select('*').order('order_position');
            if (error) return mainContent.innerHTML = `<div class="empty-state">Erro ao carregar módulos. <br><small>${error.message}</small></div>`;

            modulesMap.clear();
            modules.forEach(m => modulesMap.set(m.key, m));

            mainContent.innerHTML = '';
            modules.forEach(mod => {
                const hasAccess = currentUser.isPremium || !mod.product_id || currentUser.purchasedProducts.includes(mod.product_id);

                const card = document.createElement('div');
                card.className = `card ${!hasAccess ? 'locked' : ''}`;
                card.innerHTML = `<div class="card-image" style="background-image: url('${mod.image_url || 'https://placehold.co/200x140/e0e0e0/333?text=Img'}')"></div><span class="card-title">${mod.name}</span>`;
                if (hasAccess) card.onclick = () => loadSubModules(mod.key);
                else card.onclick = () => alert('Você precisa de adquirir este módulo para o poder aceder.');
                mainContent.appendChild(card);
            });
        }

        async function loadSubModules(moduleKey, push = true) {
            if (push) history.pushState({ view: 'subModule', key: moduleKey }, '', `#submodule/${moduleKey}`);
            setActiveNav('subModule');

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading active">A carregar...</div>';

            const { data: subModules, error } = await supabase.from('sub_modules').select('*').eq('module_key', moduleKey).order('order_position');
            if (error) return mainContent.innerHTML = `<div class="empty-state">Erro ao carregar. <br><small>${error.message}</small></div>`;

            const parentModule = modulesMap.get(moduleKey);
            const backButtonHtml = `<button class="back-button" onclick="history.back()">← Voltar aos Módulos</button>`;
            mainContent.innerHTML = `${backButtonHtml}<h2 class="module-title">${parentModule.name}</h2>`;

            if (subModules.length === 0) {
                mainContent.innerHTML += '<div class="empty-state">Nenhum conteúdo disponível neste módulo ainda.</div>';
            } else {
                subModules.forEach(sm => {
                    subModulesMap.set(sm.id, sm);
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<div class="card-image" style="background-image: url('${sm.image_url || 'https://placehold.co/200x140/e0e0e0/333?text=Img'}');"></div><span class="card-title">${sm.name}</span>`;
                    card.onclick = () => loadModuleContents(sm.id);
                    mainContent.appendChild(card);
                });
                mainContent.insertAdjacentHTML('beforeend', backButtonHtml);
            }
        }

        async function loadModuleContents(subModuleId, push = true) {
            const subModule = subModulesMap.get(subModuleId);
            if (!subModule) return mainContent.innerHTML = '<div class="empty-state">Sub-módulo não encontrado.</div>';

            if (push) history.pushState({ view: 'contentList', id: subModuleId }, '', `#contentlist/${subModuleId}`);
            setActiveNav('contentList');

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading active">A carregar conteúdos...</div>';

            const contents = Array.from(contentsMap.values())
                .filter(c => c.sub_module_id === subModuleId)
                .sort((a, b) => a.order_position - b.order_position);

            const backButtonHtml = `<button class="back-button" onclick="history.back()">← Voltar</button>`;
            mainContent.innerHTML = `${backButtonHtml}<h2 class="module-title">${subModule.name}</h2>`;

            if (contents.length === 0) {
                mainContent.innerHTML += '<div class="empty-state">Nenhum conteúdo disponível ainda.</div>';
            } else {
                contents.forEach(content => {
                    const parentModule = modulesMap.get(content.module_key);
                    const moduleProductId = parentModule ? parentModule.product_id : null;
                    const hasModuleAccess = currentUser.isPremium || !moduleProductId || currentUser.purchasedProducts.includes(moduleProductId);
                    
                    let hasAccess = false;
                    if (content.product_id) {
                        hasAccess = currentUser.isPremium || currentUser.purchasedProducts.includes(content.product_id);
                    } else {
                        hasAccess = hasModuleAccess;
                    }

                    const card = document.createElement('div');
                    card.className = `card ${!hasAccess ? 'locked' : ''}`;
                    card.innerHTML = `<div class="card-image" style="background-image: url('${content.image_url || 'https://placehold.co/200x140/e0e0e0/333?text=Img'}');"></div><span class="card-title">${content.title}</span>`;

                    if(hasAccess) {
                        card.onclick = () => openContent(content.id);
                    } else {
                        card.onclick = () => alert('Você precisa de adquirir este conteúdo para o poder aceder.');
                    }
                    mainContent.appendChild(card);
                });
                mainContent.insertAdjacentHTML('beforeend', backButtonHtml);
            }
        }

        function openContent(contentId, push = true) {
            const content = contentsMap.get(contentId);
            if (!content) return;
            if (push) history.pushState({ view: 'content', id: contentId }, '', `#content/${contentId}`);
            setActiveNav('content');
            if (content.content_type === 'audio') showAudioPlayer(content);
            else showGenericContent(content);
        }

        function showGenericContent(content) {
            const mainContent = document.getElementById('mainContent');
            const backButtonHtml = `<button class="back-button" onclick="history.back()">← Voltar</button>`;
            let contentHtml = '';
            if (content.content_type === 'iframe' && content.content_url) {
                contentHtml = `<div class="iframe-container"><iframe src="${content.content_url}" style="width: 100%; height: 100%; border: none; border-radius: 10px;" frameborder="0" allowfullscreen></iframe></div>`;
            } else if (content.content_type === 'html') {
                contentHtml = `<div style="grid-column: 1/-1; background: white; padding: 20px; border-radius: 15px;">${content.content_html || '<p>Conteúdo não disponível</p>'}</div>`;
            }
            mainContent.innerHTML = `${backButtonHtml}<h2 class="module-title">${content.title}</h2>${contentHtml}${backButtonHtml}`;
        }

        function showAudioPlayer(content) {
            const mainContent = document.getElementById('mainContent');
            const backButtonHtml = `<button class="back-button" onclick="goBackFromPlayer()">← Voltar</button>`;
            mainContent.innerHTML = `${backButtonHtml}<div class="audio-player-view"><div class="player-art"><img src="${content.image_url || 'https://placehold.co/220x220/667eea/ffffff?text=Audio'}" class="player-art-image"></div><div class="player-info"><h2 class="player-title">${content.title}</h2></div><div class="player-progress-container"><div class="progress-time"><span id="currentTime">0:00</span><span id="totalDuration">0:00</span></div><input type="range" id="progressBar" class="progress-bar" value="0" step="1"></div><div class="player-controls"><button class="control-btn" id="rewindBtn">⏮️</button><button class="control-btn play-pause-btn" id="playPauseBtn">▶️</button><button class="control-btn" id="forwardBtn">⏭️</button></div></div>${backButtonHtml}`;
            const audio = new Audio(content.content_url);
            currentAudio = audio;
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressBar = document.getElementById('progressBar');
            const formatTime = (s) => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
            audio.onloadedmetadata = () => { progressBar.max = audio.duration; document.getElementById('totalDuration').textContent = formatTime(audio.duration); };
            audio.ontimeupdate = () => { progressBar.value = audio.currentTime; document.getElementById('currentTime').textContent = formatTime(audio.currentTime); };
            audio.onended = () => playPauseBtn.innerHTML = '▶️';
            playPauseBtn.onclick = () => { audio.paused ? (audio.play(), playPauseBtn.innerHTML = '⏸️') : (audio.pause(), playPauseBtn.innerHTML = '▶️'); };
            progressBar.oninput = () => audio.currentTime = progressBar.value;
            document.getElementById('rewindBtn').onclick = () => audio.currentTime -= 10;
            document.getElementById('forwardBtn').onclick = () => audio.currentTime += 10;
        }

        function goBackFromPlayer() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            history.back();
        }

        async function loadFeed(push = true) {
            if (push && (history.state?.view !== 'feed')) history.pushState({ view: 'feed' }, '', '#feed');
            setActiveNav('feed');
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading active">A carregar feed...</div>';
            const { data, error } = await supabase.from('feed_posts').select('*').eq('active', true).order('created_at', { ascending: false });
            if (error) return mainContent.innerHTML = `<div class="empty-state">Erro ao carregar o feed. <br><small>${error.message}</small></div>`;
            if (!data || data.length === 0) return mainContent.innerHTML = '<div class="empty-state">Nenhuma postagem no feed ainda.</div>';
            mainContent.innerHTML = '<div class="feed-container"></div>';
            mainContent.querySelector('.feed-container').innerHTML = data.map(post => `<div class="feed-post"><div class="feed-post-header"><div class="feed-author-avatar">🛡️</div><div class="feed-author-info"><div class="feed-author-name">${post.title}</div><div class="feed-post-time">${new Date(post.created_at).toLocaleDateString('pt-BR')}</div></div></div><div class="feed-post-content">${post.content}</div>${post.image_url ? `<img src="${post.image_url}" class="feed-post-image">` : ''}</div>`).join('');
        }

        async function loadCommunity(push = true) {
            if (push && (history.state?.view !== 'community')) history.pushState({ view: 'community' }, '', '#community');
            setActiveNav('community');
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `<div class="community-container"><div class="community-input-box"><textarea class="community-input" id="communityMessage" placeholder="Partilhe a sua experiência..."></textarea><button class="community-submit-btn" onclick="sendCommunityMessage()">Enviar Mensagem</button><p style="font-size: 12px; color: #999; margin-top: 10px;">* As mensagens serão revistas antes de aparecerem</p></div><div id="communityMessagesList"><div class="loading active">A carregar mensagens...</div></div></div>`;
            const { data, error } = await supabase.from('community_posts').select('*').eq('status', 'approved').order('created_at', { ascending: false });
            const messagesListEl = document.getElementById('communityMessagesList');
            if (error) return messagesListEl.innerHTML = `<div class="empty-state">Erro ao carregar as mensagens. <br><small>${error.message}</small></div>`;
            if (!data || data.length === 0) return messagesListEl.innerHTML = '<div class="empty-state">Seja o primeiro a partilhar!</div>';
            messagesListEl.innerHTML = data.map(msg => { const author = profilesMap.get(msg.user_id) || { name: 'Anónimo', avatar_url: null }; return `<div class="community-message"><div class="community-message-header"><div class="community-avatar">${author.avatar_url ? `<img src="${author.avatar_url}" alt="${author.name}">` : author.name.charAt(0).toUpperCase()}</div><div class="community-author">${author.name}</div><div class="community-time">${new Date(msg.created_at).toLocaleDateString('pt-BR')}</div></div><div class="community-text">${msg.content}</div></div>`; }).join('');
        }

        async function sendCommunityMessage() {
            const messageInput = document.getElementById('communityMessage');
            const message = messageInput.value.trim();
            if (!message) return alert('Por favor, escreva uma mensagem.');
            const { error } = await supabase.from('community_posts').insert([{ user_id: currentUser.id, content: message, status: 'pending' }]);
            if (error) alert(`Erro ao enviar mensagem: ${error.message}`);
            else { alert('Mensagem enviada! Aguarde a aprovação.'); messageInput.value = ''; }
        }

        function loadProfile(push = true) {
            if (push && (history.state?.view !== 'profile')) history.pushState({ view: 'profile' }, '', '#profile');
            setActiveNav('profile');
            const mainContent = document.getElementById('mainContent');
            const profile = currentUser.profile || {};
            const initial = (profile.name || currentUser.email || 'U').charAt(0).toUpperCase();
            mainContent.innerHTML = `<div class="profile-container"><div class="profile-header"><h2 class="module-title" style="margin-bottom: 20px;">Seu Perfil</h2><div class="profile-avatar" onclick="document.getElementById('avatarFile').click()">${profile.avatar_url ? `<img src="${profile.avatar_url}" alt="Avatar">` : initial}<div class="profile-avatar-edit">📷</div><input type="file" id="avatarFile" accept="image/*" style="display: none;" onchange="uploadAvatar(event)"></div><p class="profile-tip">Clique no ícone para alterar a sua foto</p></div><div class="profile-form"><label for="profileName">Nome</label><input type="text" class="profile-input" id="profileName" placeholder="O seu nome" value="${profile.name || ''}"><label for="profileEmail">Email (não pode ser alterado)</label><input type="email" class="profile-input" id="profileEmail" value="${currentUser.email}" disabled><button class="profile-save-btn" onclick="saveProfile()">Guardar Alterações</button></div><button class="logout-btn" onclick="logout()">Sair do App</button></div>`;
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            if (!name) return alert('O nome não pode ficar em branco.');
            const { error } = await supabase.from('profiles').update({ name: name, updated_at: new Date() }).eq('id', currentUser.id);
            if (error) alert(`Erro ao atualizar o perfil: ${error.message}`);
            else { alert('Perfil atualizado com sucesso!'); currentUser.profile.name = name; profilesMap.set(currentUser.id, { ...profilesMap.get(currentUser.id), name: name }); updateGreeting(); loadProfile(false); }
        }

        async function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            const filePath = `${currentUser.id}/${Date.now()}.${file.name.split('.').pop()}`;
            let { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });
            if (uploadError) return alert(`Erro ao carregar a imagem: ${uploadError.message}`);
            const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
            let { error: updateError } = await supabase.from('profiles').update({ avatar_url: data.publicUrl, updated_at: new Date() }).eq('id', currentUser.id);
            if (updateError) alert(`Erro ao guardar a URL do avatar: ${updateError.message}`);
            else { currentUser.profile.avatar_url = data.publicUrl; profilesMap.set(currentUser.id, { ...profilesMap.get(currentUser.id), avatar_url: data.publicUrl }); loadProfile(false); }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = `${window.location.origin}/index.html`;
        }

        Object.assign(window, { handleNavClick, loadModuleContents, openContent, sendCommunityMessage, logout, saveProfile, uploadAvatar, goBackFromPlayer, loadSubModules });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>