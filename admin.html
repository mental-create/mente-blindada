<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Mente Blindada</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 32px;
            font-weight: 800;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #4169E1;
            border-bottom-color: #4169E1;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"],
        input[type="url"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4169E1;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            background: #4169E1;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #3051b8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #666;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .content-list {
            margin-top: 30px;
        }

        .content-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .content-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .content-info {
            flex: 1;
        }

        .content-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .content-module {
            color: #666;
            font-size: 14px;
        }

        .content-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            white-space: nowrap;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-active {
            background: #27ae60;
            color: white;
        }

        .status-inactive {
            background: #e74c3c;
            color: white;
        }

        .upload-area {
            border: 2px dashed #4169E1;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #f0f4f8;
        }

        .preview-image {
            max-width: 200px;
            margin-top: 15px;
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .module-item {
            display: flex;
            align-items: center;
            gap: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .module-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .module-item-info {
            flex: 1;
        }

        .module-item-title {
            font-weight: 700;
            color: #333;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <button class="logout-btn" onclick="logout()">Sair</button>
        <h1>üîß PAINEL ADMINISTRATIVO</h1>
        
        <div id="messageArea"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">Adicionar Conte√∫do</button>
            <button class="tab" onclick="switchTab('list')">Listar Conte√∫dos</button>
            <button class="tab" onclick="switchTab('modules')">Gerenciar M√≥dulos</button>
            <button class="tab" onclick="switchTab('feed')">Gerenciar Feed</button>
            <button class="tab" onclick="switchTab('community')">Moderar Comunidade</button>
        </div>

        <!-- Adicionar Conte√∫do -->
        <div id="add-section" class="content-section active">
            <form id="contentForm">
                <div class="form-group">
                    <label for="module">M√≥dulo</label>
                    <select id="module" required>
                        <option value="">Selecione o m√≥dulo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">T√≠tulo do Conte√∫do</label>
                    <input type="text" id="title" placeholder="Ex: T√©cnicas de Respira√ß√£o" required>
                </div>

                <div class="form-group">
                    <label for="description">Descri√ß√£o (opcional)</label>
                    <textarea id="description" placeholder="Breve descri√ß√£o do conte√∫do..."></textarea>
                </div>

                <div class="form-group">
                    <label for="imageUrl">URL da Imagem</label>
                    <input type="url" id="imageUrl" placeholder="https://exemplo.com/imagem.jpg">
                </div>

                <div class="form-group">
                    <label for="contentType">Tipo de Conte√∫do</label>
                    <select id="contentType" onchange="toggleContentInput()">
                        <option value="url">URL Externa (Gamma, etc.)</option>
                        <option value="iframe">iFrame</option>
                        <option value="html">C√≥digo HTML</option>
                    </select>
                </div>

                <div class="form-group" id="urlInput">
                    <label for="contentUrl">URL do Conte√∫do</label>
                    <input type="url" id="contentUrl" placeholder="https://gamma.app/public/seu-conteudo">
                </div>

                <div class="form-group" id="htmlInput" style="display: none;">
                    <label for="contentHtml">C√≥digo HTML</label>
                    <textarea id="contentHtml" placeholder="Cole o c√≥digo HTML aqui..."></textarea>
                </div>

                <div class="form-group">
                    <label for="bgColor">Cor de Fundo (opcional)</label>
                    <input type="text" id="bgColor" placeholder="#a8d5e2">
                </div>

                <div class="form-group">
                    <label for="orderPosition">Ordem de Exibi√ß√£o</label>
                    <input type="number" id="orderPosition" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isActive" checked>
                        Conte√∫do Ativo
                    </label>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn">üíæ Salvar Conte√∫do</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Limpar</button>
                </div>
            </form>
        </div>

        <!-- Listar Conte√∫do -->
        <div id="list-section" class="content-section">
            <div class="form-group">
                <label for="filterModule">Filtrar por M√≥dulo</label>
                <select id="filterModule" onchange="loadContents()">
                    <option value="">Todos os M√≥dulos</option>
                </select>
            </div>

            <div class="content-list" id="contentList">
                <div class="loading">Carregando conte√∫dos...</div>
            </div>
        </div>

        <!-- Gerenciar M√≥dulos -->
        <div id="modules-section" class="content-section">
            <h2>Gerenciar M√≥dulos</h2>
            <p>Adicione ou edite os m√≥dulos do seu app.</p>
            
            <form id="moduleForm" style="margin-top: 20px;">
                <input type="hidden" id="editModuleKey">
                <div class="form-group">
                    <label for="newModuleKey">Chave do M√≥dulo (sem espa√ßos)</label>
                    <input type="text" id="newModuleKey" placeholder="Ex: meditacao" required>
                </div>
                
                <div class="form-group">
                    <label for="newModuleName">Nome do M√≥dulo</label>
                    <input type="text" id="newModuleName" placeholder="Ex: Medita√ß√£o Guiada" required>
                </div>
                
                <div class="form-group">
                    <label for="newModuleImage">URL da Imagem</label>
                    <input type="url" id="newModuleImage" placeholder="https://exemplo.com/imagem.jpg">
                </div>
                
                <div class="form-group">
                    <label for="newModuleColor">Cor de Fundo</label>
                    <input type="text" id="newModuleColor" placeholder="#a8d5e2">
                </div>
                
                <div class="form-group">
                    <label for="newModuleOrder">Ordem de Exibi√ß√£o</label>
                    <input type="number" id="newModuleOrder" value="1" min="1" required>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn" id="saveModuleBtn">Adicionar M√≥dulo</button>
                    <button type="button" class="btn btn-secondary" onclick="resetModuleForm()">Limpar</button>
                </div>
            </form>

            <div style="margin-top: 30px;">
                <h3>M√≥dulos Atuais</h3>
                <div id="moduleList">
                    <div class="loading">Carregando m√≥dulos...</div>
                </div>
            </div>
        </div>

        <!-- Gerenciar Feed -->
        <div id="feed-section" class="content-section">
            <h2>Gerenciar Feed</h2>
            
            <form id="feedForm" style="margin-bottom: 30px;">
                <input type="hidden" id="editFeedId">
                <div class="form-group">
                    <label for="feedTitle">T√≠tulo do Post</label>
                    <input type="text" id="feedTitle" placeholder="T√≠tulo do post" required>
                </div>
                
                <div class="form-group">
                    <label for="feedCategory">Categoria</label>
                    <select id="feedCategory" required>
                        <option value="">Selecione...</option>
                        <option value="motivacao">üí™ Motiva√ß√£o</option>
                        <option value="meditacao">üßò Medita√ß√£o</option>
                        <option value="exercicios">üèÉ Exerc√≠cios</option>
                        <option value="alimentacao">ü•ó Alimenta√ß√£o</option>
                        <option value="sono">üò¥ Sono</option>
                        <option value="relacionamentos">‚ù§Ô∏è Relacionamentos</option>
                        <option value="produtividade">üìà Produtividade</option>
                        <option value="autoconhecimento">üîç Autoconhecimento</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="feedContent">Conte√∫do</label>
                    <textarea id="feedContent" rows="5" placeholder="Conte√∫do do post..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="feedImage">URL da Imagem (opcional)</label>
                    <input type="url" id="feedImage" placeholder="https://exemplo.com/imagem.jpg">
                </div>
                
                <div class="form-group">
                    <label for="feedTags">Tags (separadas por v√≠rgula)</label>
                    <input type="text" id="feedTags" placeholder="sa√∫de mental, bem-estar">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="feedActive" checked> Post Ativo
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="feedHighlight"> ‚≠ê Destacar Post
                    </label>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn" id="saveFeedBtn">üíæ Publicar Post</button>
                    <button type="button" class="btn btn-secondary" onclick="resetFeedForm()">Limpar</button>
                </div>
            </form>
            
            <h3>Posts Publicados</h3>
            <div id="feedList">
                <div class="loading">Carregando posts...</div>
            </div>
        </div>

        <!-- Moderar Comunidade -->
        <div id="community-section" class="content-section">
            <h2>Moderar Comunidade</h2>
            
            <div class="form-group">
                <label for="filterStatus">Filtrar por Status</label>
                <select id="filterStatus" onchange="loadCommunityMessages()">
                    <option value="pending">Pendentes de Aprova√ß√£o</option>
                    <option value="approved">Aprovadas</option>
                    <option value="rejected">Rejeitadas</option>
                    <option value="all">Todas</option>
                </select>
            </div>
            
            <div id="communityList" style="margin-top: 20px;">
                <div class="loading">Carregando mensagens...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://gvrnnfzflefecxqedgih.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cm5uZnpmbGVmZWN4cWVkZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NjE3MzIsImV4cCI6MjA3NDEzNzczMn0.kmvAFT7qlExTk2JQf5NjLB0sfwKaqb8RfxvdCbl8oXo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Verificar autentica√ß√£o e permiss√£o de admin
        async function checkAuthAndAdmin() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'admin-login.html';
                    return false;
                }
                
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('is_admin')
                    .eq('id', session.user.id)
                    .single();
                
                if (error || !profile || !profile.is_admin) {
                    await supabase.auth.signOut();
                    window.location.href = 'admin-login.html';
                    return false;
                }
                
                return true;
            } catch (e) {
                console.error('Erro na verifica√ß√£o de admin:', e);
                await supabase.auth.signOut();
                window.location.href = 'admin-login.html';
                return false;
            }
        }

        // Logout
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'admin-login.html';
        }

        // Alternar abas
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            const targetTab = document.querySelector(`.tab[onclick="switchTab('${tab}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            document.getElementById(`${tab}-section`).classList.add('active');
            
            if (tab === 'list') {
                loadContents();
            } else if (tab === 'modules') {
                loadModules();
            } else if (tab === 'feed') {
                loadFeedPosts();
            } else if (tab === 'community') {
                loadCommunityMessages();
            }
        }

        // Alternar tipo de conte√∫do
        function toggleContentInput() {
            const type = document.getElementById('contentType').value;
            document.getElementById('urlInput').style.display = type === 'url' || type === 'iframe' ? 'block' : 'none';
            document.getElementById('htmlInput').style.display = type === 'html' ? 'block' : 'none';
        }

        // Salvar conte√∫do
        document.getElementById('contentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('contentForm').dataset.editId;
            const isEditing = !!editId;

            const formData = {
                module: document.getElementById('module').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                image_url: document.getElementById('imageUrl').value || null,
                content_type: document.getElementById('contentType').value,
                content_url: document.getElementById('contentUrl').value || null,
                content_html: document.getElementById('contentHtml').value || null,
                bg_color: document.getElementById('bgColor').value || null,
                order_position: parseInt(document.getElementById('orderPosition').value),
                active: document.getElementById('isActive').checked
            };

            try {
                let result;
                
                if (isEditing) {
                    result = await supabase.from('contents').update(formData).eq('id', editId);
                } else {
                    result = await supabase.from('contents').insert([formData]);
                }

                const { error } = result;

                if (!error) {
                    showMessage('Conte√∫do salvo com sucesso!', 'success');
                    if (isEditing) {
                        cancelEdit();
                    } else {
                        resetForm();
                    }
                    if (document.getElementById('list-section').classList.contains('active')) {
                        loadContents();
                    }
                } else {
                    showMessage('Erro ao salvar: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao salvar conte√∫do', 'error');
            }
        });

        // Carregar conte√∫dos
        async function loadContents() {
            const filterModule = document.getElementById('filterModule').value;
            let query = supabase.from('contents').select('*');
            
            if (filterModule) {
                query = query.eq('module', filterModule);
            }
            
            query = query.order('order_position');

            try {
                const { data, error } = await query;
                
                if (!error && data) {
                    displayContents(data);
                } else {
                    document.getElementById('contentList').innerHTML = '<p>Erro ao carregar conte√∫dos</p>';
                }
            } catch (error) {
                document.getElementById('contentList').innerHTML = '<p>Erro ao carregar conte√∫dos</p>';
            }
        }

        // Exibir conte√∫dos
        function displayContents(contents) {
            if (contents.length === 0) {
                document.getElementById('contentList').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum conte√∫do encontrado</p>';
                return;
            }

            const moduleNames = {
                'quiz': 'Quiz Interativo',
                'exercises': 'Exerc√≠cios',
                'library': 'Biblioteca',
                'diary': 'Di√°rio'
            };

            let html = '';
            contents.forEach(content => {
                html += `
                    <div class="content-item">
                        <div class="content-image" style="background-image: url('${content.image_url || ''}'); background-color: ${content.bg_color || '#e0e0e0'}"></div>
                        <div class="content-info">
                            <div class="content-title">
                                ${content.title}
                                <span class="status-badge ${content.active ? 'status-active' : 'status-inactive'}">
                                    ${content.active ? '‚úî Ativo' : '‚úó Inativo'}
                                </span>
                            </div>
                            <div class="content-module">
                                <strong>M√≥dulo:</strong> ${moduleNames[content.module] || content.module} | 
                                <strong>Ordem:</strong> ${content.order_position} |
                                <strong>Tipo:</strong> ${content.content_type.toUpperCase()}
                            </div>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small" onclick="editContent('${content.id}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-small btn-danger" onclick="deleteContent('${content.id}')">üóëÔ∏è Excluir</button>
                            <button class="btn btn-small btn-secondary" onclick="toggleStatus('${content.id}', ${content.active})">
                                ${content.active ? 'üîí Desativar' : 'üîì Ativar'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('contentList').innerHTML = html;
        }

        // Alternar status
        async function toggleStatus(id, currentStatus) {
            try {
                const { error } = await supabase.from('contents').update({ active: !currentStatus }).eq('id', id);
                if (!error) {
                    showMessage(`Conte√∫do ${!currentStatus ? 'ativado' : 'desativado'} com sucesso!`, 'success');
                    loadContents();
                } else {
                    showMessage('Erro ao alterar status: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao alterar status', 'error');
            }
        }

        // Editar conte√∫do
        async function editContent(id) {
            try {
                const { data, error } = await supabase.from('contents').select('*').eq('id', id).single();
                if (error) {
                    showMessage('Erro ao carregar conte√∫do: ' + error.message, 'error');
                    return;
                }
                
                if (data) {
                    switchTab('add');
                    
                    document.getElementById('module').value = data.module;
                    document.getElementById('title').value = data.title;
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('imageUrl').value = data.image_url || '';
                    document.getElementById('bgColor').value = data.bg_color || '';
                    document.getElementById('orderPosition').value = data.order_position;
                    document.getElementById('isActive').checked = data.active;
                    document.getElementById('contentType').value = data.content_type;
                    
                    toggleContentInput();
                    if (data.content_type === 'url' || data.content_type === 'iframe') {
                        document.getElementById('contentUrl').value = data.content_url || '';
                    } else if (data.content_type === 'html') {
                        document.getElementById('contentHtml').value = data.content_html || '';
                    }

                    document.getElementById('contentForm').dataset.editId = id;
                    document.querySelector('#contentForm button[type="submit"]').innerHTML = 'üíæ Atualizar Conte√∫do';
                    
                    if (!document.getElementById('cancelEdit')) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.id = 'cancelEdit';
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'btn btn-secondary';
                        cancelBtn.innerHTML = 'Cancelar Edi√ß√£o';
                        cancelBtn.onclick = cancelEdit;
                        document.querySelector('#contentForm .button-group').appendChild(cancelBtn);
                    }
                    
                    showMessage('Conte√∫do carregado para edi√ß√£o', 'success');
                }
            } catch (error) {
                showMessage('Erro ao editar conte√∫do', 'error');
            }
        }

        // Cancelar edi√ß√£o
        function cancelEdit() {
            delete document.getElementById('contentForm').dataset.editId;
            document.querySelector('#contentForm button[type="submit"]').innerHTML = 'üíæ Salvar Conte√∫do';
            const cancelBtn = document.getElementById('cancelEdit');
            if (cancelBtn) cancelBtn.remove();
            resetForm();
        }

        // Excluir conte√∫do
        async function deleteContent(id) {
            // NOTE: Replace `confirm` with a custom modal UI in production.
            if (!confirm('Tem certeza que deseja excluir este conte√∫do?')) return;
            
            try {
                const { error } = await supabase.from('contents').delete().eq('id', id);
                if (!error) {
                    showMessage('Conte√∫do exclu√≠do com sucesso!', 'success');
                    loadContents();
                } else {
                    showMessage('Erro ao excluir: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao excluir conte√∫do', 'error');
            }
        }

        // Gerenciar M√≥dulos
        async function loadModules() {
            try {
                const { data, error } = await supabase.from('modules').select('*').order('order_position');
                if (!error && data) {
                    displayModules(data);
                    updateModuleSelects(data);
                }
            } catch (error) {
                showMessage('Erro ao carregar m√≥dulos', 'error');
            }
        }

        function displayModules(modules) {
            const list = document.getElementById('moduleList');
            if (modules.length === 0) {
                list.innerHTML = '<p>Nenhum m√≥dulo encontrado</p>';
                return;
            }
            
            let html = '';
            modules.forEach(mod => {
                html += `
                    <div class="module-item">
                        <div class="module-item-image" style="background-image: url('${mod.image_url || ''}'); background-color: ${mod.bg_color || '#e0e0e0'}"></div>
                        <div class="module-item-info">
                            <div class="module-item-title">${mod.name}</div>
                            <small>Chave: ${mod.key} | Ordem: ${mod.order_position}</small>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small" onclick="editModule('${mod.key}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-small btn-danger" onclick="deleteModule('${mod.key}')">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        // Salvar m√≥dulo
        document.getElementById('moduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const key = document.getElementById('newModuleKey').value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const name = document.getElementById('newModuleName').value;
            const imageUrl = document.getElementById('newModuleImage').value || null;
            const bgColor = document.getElementById('newModuleColor').value || null;
            const orderPosition = parseInt(document.getElementById('newModuleOrder').value);
            const editKey = document.getElementById('editModuleKey').value;

            try {
                let result;
                if (editKey) {
                    result = await supabase.from('modules').update({ 
                        name, 
                        image_url: imageUrl, 
                        bg_color: bgColor,
                        order_position: orderPosition 
                    }).eq('key', editKey);
                } else {
                    result = await supabase.from('modules').insert([{ 
                        key, 
                        name, 
                        image_url: imageUrl, 
                        bg_color: bgColor,
                        order_position: orderPosition 
                    }]);
                }
                
                const { error } = result;
                if (!error) {
                    showMessage(`M√≥dulo ${editKey ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                    resetModuleForm();
                    loadModules();
                } else {
                    showMessage(`Erro ao salvar m√≥dulo: ${error.message}`, 'error');
                }
            } catch (error) {
                showMessage('Erro ao salvar m√≥dulo', 'error');
            }
        });

        // Editar m√≥dulo
        async function editModule(key) {
            try {
                const { data, error } = await supabase.from('modules').select('*').eq('key', key).single();
                if (error) {
                    showMessage('Erro ao carregar m√≥dulo: ' + error.message, 'error');
                    return;
                }
                
                if (data) {
                    switchTab('add');
                    
                    document.getElementById('newModuleKey').value = data.key;
                    document.getElementById('newModuleKey').disabled = true;
                    document.getElementById('newModuleName').value = data.name;
                    document.getElementById('newModuleImage').value = data.image_url || '';
                    document.getElementById('newModuleColor').value = data.bg_color || '';
                    document.getElementById('newModuleOrder').value = data.order_position;
                    document.getElementById('editModuleKey').value = data.key;
                    document.getElementById('saveModuleBtn').innerHTML = 'üíæ Atualizar M√≥dulo';
                    
                    showMessage('M√≥dulo carregado para edi√ß√£o', 'success');
                }
            } catch (error) {
                showMessage('Erro ao carregar m√≥dulo', 'error');
            }
        }

        // Excluir m√≥dulo
        async function deleteModule(key) {
            // NOTE: Replace `confirm` with a custom modal UI in production.
            if (!confirm('Tem certeza? Todos os conte√∫dos deste m√≥dulo n√£o ser√£o mais exibidos.')) return;
            
            try {
                const { error } = await supabase.from('modules').delete().eq('key', key);
                if (!error) {
                    showMessage('M√≥dulo exclu√≠do com sucesso!', 'success');
                    loadModules();
                } else {
                    showMessage('Erro ao excluir m√≥dulo: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao excluir m√≥dulo', 'error');
            }
        }

        // Reset formul√°rio m√≥dulo
        function resetModuleForm() {
            document.getElementById('moduleForm').reset();
            document.getElementById('editModuleKey').value = '';
            document.getElementById('newModuleKey').disabled = false;
            document.getElementById('saveModuleBtn').innerHTML = 'Adicionar M√≥dulo';
        }

        // Atualizar selects de m√≥dulos
        function updateModuleSelects(modules) {
            const selects = document.querySelectorAll('#module, #filterModule');
            selects.forEach(select => {
                const currentSelection = select.value;
                const defaultOptions = Array.from(select.options).filter(opt => opt.value === '');
                select.innerHTML = '';
                defaultOptions.forEach(opt => select.appendChild(opt));

                modules.forEach(mod => {
                    const option = document.createElement('option');
                    option.value = mod.key;
                    option.text = mod.name;
                    select.appendChild(option);
                });
                select.value = currentSelection;
            });
        }

        // Reset formul√°rio
        function resetForm() {
            document.getElementById('contentForm').reset();
        }

        // Mostrar mensagem
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // ====== FUN√á√ïES DO FEED ======
        async function loadFeedPosts() {
            try {
                const { data, error } = await supabase
                    .from('feed_posts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (!error && data) {
                    displayFeedPosts(data);
                }
            } catch (error) {
                console.error('Erro ao carregar posts:', error);
            }
        }

        function displayFeedPosts(posts) {
            const list = document.getElementById('feedList');
            if (posts.length === 0) {
                list.innerHTML = '<p>Nenhum post encontrado</p>';
                return;
            }
            
            let html = '';
            posts.forEach(post => {
                const statusBadge = post.active ? 
                    '<span class="status-badge status-active">‚úî Ativo</span>' : 
                    '<span class="status-badge status-inactive">‚úó Inativo</span>';
                
                html += `
                    <div class="content-item">
                        <div class="content-info">
                            <div class="content-title">
                                ${post.highlight ? '‚≠ê ' : ''}${post.title}
                                ${statusBadge}
                            </div>
                            <div class="content-module">
                                <strong>Categoria:</strong> ${post.category} | 
                                <strong>Data:</strong> ${new Date(post.created_at).toLocaleDateString('pt-BR')}
                            </div>
                            <div style="color: #666; margin-top: 5px;">${post.content.substring(0, 100)}...</div>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small" onclick="editFeedPost('${post.id}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-small btn-danger" onclick="deleteFeedPost('${post.id}')">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        // Salvar post do feed
        document.getElementById('feedForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('editFeedId').value;
            const formData = {
                title: document.getElementById('feedTitle').value,
                category: document.getElementById('feedCategory').value,
                content: document.getElementById('feedContent').value,
                image_url: document.getElementById('feedImage').value || null,
                tags: document.getElementById('feedTags').value || null,
                active: document.getElementById('feedActive').checked,
                highlight: document.getElementById('feedHighlight').checked
            };
            
            try {
                let result;
                if (editId) {
                    result = await supabase.from('feed_posts').update(formData).eq('id', editId);
                } else {
                    result = await supabase.from('feed_posts').insert([formData]);
                }
                
                const { error } = result;
                if (!error) {
                    showMessage(`Post ${editId ? 'atualizado' : 'publicado'} com sucesso!`, 'success');
                    resetFeedForm();
                    loadFeedPosts();
                } else {
                    showMessage('Erro ao salvar post: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao salvar post', 'error');
            }
        });

        async function editFeedPost(id) {
            try {
                const { data, error } = await supabase.from('feed_posts').select('*').eq('id', id).single();
                if (!error && data) {
                    document.getElementById('editFeedId').value = data.id;
                    document.getElementById('feedTitle').value = data.title;
                    document.getElementById('feedCategory').value = data.category;
                    document.getElementById('feedContent').value = data.content;
                    document.getElementById('feedImage').value = data.image_url || '';
                    document.getElementById('feedTags').value = data.tags || '';
                    document.getElementById('feedActive').checked = data.active;
                    document.getElementById('feedHighlight').checked = data.highlight;
                    document.getElementById('saveFeedBtn').innerHTML = 'üíæ Atualizar Post';
                }
            } catch (error) {
                showMessage('Erro ao carregar post', 'error');
            }
        }

        async function deleteFeedPost(id) {
            // NOTE: Replace `confirm` with a custom modal UI in production.
            if (!confirm('Tem certeza que deseja excluir este post?')) return;
            
            try {
                const { error } = await supabase.from('feed_posts').delete().eq('id', id);
                if (!error) {
                    showMessage('Post exclu√≠do com sucesso!', 'success');
                    loadFeedPosts();
                }
            } catch (error) {
                showMessage('Erro ao excluir post', 'error');
            }
        }

        function resetFeedForm() {
            document.getElementById('feedForm').reset();
            document.getElementById('editFeedId').value = '';
            document.getElementById('feedActive').checked = true;
            document.getElementById('feedHighlight').checked = false;
            document.getElementById('saveFeedBtn').innerHTML = 'üíæ Publicar Post';
        }

        // ====== FUN√á√ïES DA COMUNIDADE ======
        async function loadCommunityMessages() {
            const filter = document.getElementById('filterStatus')?.value || 'pending';
            
            console.log('Carregando mensagens com filtro:', filter);
            
            try {
                let query = supabase
                    .from('community_posts')
                    .select(`
                        *,
                        profiles (
                            name,
                            email
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                // Filtrar por status
                if (filter === 'pending') {
                    query = query.eq('status', 'pending');
                } else if (filter === 'approved') {
                    query = query.eq('status', 'approved');
                } else if (filter === 'rejected') {
                    query = query.eq('status', 'rejected');
                }
                
                const { data: messages, error } = await query;
                
                if (error) {
                    console.error('Erro ao carregar mensagens:', error);
                    document.getElementById('communityList').innerHTML = `
                        <p style="color: red;">Erro: ${error.message}</p>
                    `;
                    return;
                }
                
                console.log('Mensagens carregadas:', messages);
                displayCommunityMessages(messages || []);
                
            } catch (error) {
                console.error('Erro geral:', error);
                document.getElementById('communityList').innerHTML = `
                    <p style="color: red;">Erro: ${error.message}</p>
                `;
            }
        }

        function displayCommunityMessages(messages) {
            const list = document.getElementById('communityList');
            
            if (messages.length === 0) {
                list.innerHTML = '<p>Nenhuma mensagem encontrada</p>';
                return;
            }
            
            let html = '';
            messages.forEach(msg => {
                const author = msg.profiles ? msg.profiles.name || msg.profiles.email : 'An√¥nimo';
                
                let statusBadge = '';
                if (msg.status === 'approved') {
                    statusBadge = '<span class="status-badge status-active">Aprovada</span>';
                } else if (msg.status === 'pending') {
                    statusBadge = '<span class="status-badge status-inactive">Pendente</span>';
                } else if (msg.status === 'rejected') {
                    statusBadge = '<span class="status-badge" style="background: #e74c3c; color: white;">Rejeitada</span>';
                }
                
                html += `
                    <div class="content-item">
                        <div class="content-info">
                            <div class="content-title">
                                ${author} ${statusBadge}
                            </div>
                            <div class="content-module">
                                <strong>Data:</strong> ${new Date(msg.created_at).toLocaleString('pt-BR')}
                            </div>
                            <div style="color: #333; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                ${msg.message}
                            </div>
                        </div>
                        <div class="content-actions">
                            ${msg.status === 'pending' ? `
                                <button class="btn btn-small" onclick="approveMessage('${msg.id}')">‚úÖ Aprovar</button>
                                <button class="btn btn-small btn-danger" onclick="rejectMessage('${msg.id}')">‚ùå Rejeitar</button>
                            ` : msg.status === 'approved' ? `
                                <button class="btn btn-small btn-danger" onclick="rejectMessage('${msg.id}')">‚ùå Rejeitar</button>
                            ` : `
                                <button class="btn btn-small" onclick="approveMessage('${msg.id}')">‚úÖ Aprovar</button>
                            `}
                            <button class="btn btn-small btn-danger" onclick="deleteMessage('${msg.id}')">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        async function approveMessage(id) {
            try {
                const { error } = await supabase
                    .from('community_posts')
                    .update({ 
                        status: 'approved',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (!error) {
                    showMessage('Mensagem aprovada!', 'success');
                    loadCommunityMessages();
                } else {
                    showMessage('Erro ao aprovar: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao aprovar mensagem', 'error');
            }
        }

        async function rejectMessage(id) {
            try {
                const { error } = await supabase
                    .from('community_posts')
                    .update({ 
                        status: 'rejected',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (!error) {
                    showMessage('Mensagem rejeitada!', 'success');
                    loadCommunityMessages();
                } else {
                    showMessage('Erro ao rejeitar: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao rejeitar mensagem', 'error');
            }
        }

        async function deleteMessage(id) {
            // NOTE: Replace `confirm` with a custom modal UI in production.
            if (!confirm('Tem certeza que deseja excluir esta mensagem permanentemente?')) return;
            
            try {
                const { error } = await supabase
                    .from('community_posts')
                    .delete()
                    .eq('id', id);
                
                if (!error) {
                    showMessage('Mensagem exclu√≠da!', 'success');
                    loadCommunityMessages();
                } else {
                    showMessage('Erro ao excluir: ' + error.message, 'error');
                }
            } catch (error) {
                showMessage('Erro ao excluir mensagem', 'error');
            }
        }

        // Inicializar
        async function init() {
            const isAuthAndAdmin = await checkAuthAndAdmin();
            if (isAuthAndAdmin) {
                loadModules();
            }
        }

        // Tornar fun√ß√µes globais para onclick funcionar
        window.switchTab = switchTab;
        window.toggleContentInput = toggleContentInput;
        window.resetForm = resetForm;
        window.editContent = editContent;
        window.deleteContent = deleteContent;
        window.toggleStatus = toggleStatus;
        window.cancelEdit = cancelEdit;
        window.logout = logout;
        window.loadContents = loadContents;
        window.editModule = editModule;
        window.deleteModule = deleteModule;
        window.resetModuleForm = resetModuleForm;
        window.loadModules = loadModules;
        window.loadFeedPosts = loadFeedPosts;
        window.editFeedPost = editFeedPost;
        window.deleteFeedPost = deleteFeedPost;
        window.resetFeedForm = resetFeedForm;
        window.loadCommunityMessages = loadCommunityMessages;
        window.approveMessage = approveMessage;
        window.rejectMessage = rejectMessage;
        window.deleteMessage = deleteMessage;
        
        init();
    </script>
</body>
</html>
