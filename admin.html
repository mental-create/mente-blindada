<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Mente Blindada</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        #loading-view { text-align: center; padding-top: 100px; color: #666; }
        .admin-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; }
        h1 { color: #333; margin-bottom: 30px; text-align: center; font-size: 32px; font-weight: 800; }
        h2 { margin-bottom: 20px; font-weight: 700; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
        .tab { padding: 15px 25px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab.active { color: #4169E1; border-bottom-color: #4169E1; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        input[type="text"], input[type="url"], input[type="number"], input[type="file"], input[type="checkbox"], select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: 'Montserrat', sans-serif; font-size: 14px; transition: border-color 0.3s ease; }
        input:disabled { background-color: #f8f9fa; color: #6c757d; }
        input[type="checkbox"] { width: auto; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4169E1; }
        textarea { min-height: 150px; resize: vertical; }
        .button-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px 30px; background: #4169E1; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background: #3051b8; transform: translateY(-2px); }
        .btn:disabled { background: #aaa; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .content-list { margin-top: 30px; }
        .content-item { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .content-image { width: 80px; height: 80px; border-radius: 10px; background-size: cover; background-position: center; flex-shrink: 0; }
        .content-info { flex: 1; min-width: 250px; }
        .content-title { font-weight: 700; color: #333; margin-bottom: 5px; }
        .content-module { color: #666; font-size: 14px; }
        .content-actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-small { padding: 6px 12px; font-size: 12px; white-space: nowrap; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .status-badge.status-pending { background: #ffc107; color: #333; }
        .status-badge.status-approved, .status-badge.status-active { background: #27ae60; color: white; }
        .status-badge.status-rejected, .status-badge.status-inactive { background: #e74c3c; color: white; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .message { padding: 15px; border-radius: 10px; margin-bottom: 20px; animation: fadeIn 0.5s; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .logout-btn { position: absolute; top: 30px; right: 30px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .image-preview { margin-top: 10px; }
        .image-preview img { max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd; }
        .image-preview span { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div id="loading-view"><h2>A verificar permiss√µes...</h2></div>
    <div class="admin-container" style="display: none;">
        <button class="logout-btn" onclick="logout()">Sair</button>
        <h1>üîß PAINEL ADMINISTRATIVO</h1>
        <div id="messageArea"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">Adicionar Conte√∫do</button>
            <button class="tab" onclick="switchTab('list')">Listar Conte√∫dos</button>
            <button class="tab" onclick="switchTab('submodules')">Gerir Sub-M√≥dulos</button>
            <button class="tab" onclick="switchTab('modules')">Gerir M√≥dulos</button>
            <button class="tab" onclick="switchTab('feed')">Gerir Feed</button>
            <button class="tab" onclick="switchTab('community')">Moderar Comunidade</button>
        </div>

        <div id="add-section" class="content-section">
            <h2>Adicionar ou Editar Conte√∫do</h2>
            <form id="contentForm">
                <input type="hidden" id="editContentId"><input type="hidden" id="imageUrl">
                <div class="form-group"><label for="module">M√≥dulo</label><select id="module" onchange="updateSubModuleSelect(this.value)" required></select></div>
                <div class="form-group"><label for="subModule">Sub-M√≥dulo</label><select id="subModule" required><option value="">Primeiro, selecione um m√≥dulo</option></select></div>
                <div class="form-group"><label for="title">T√≠tulo do Conte√∫do</label><input type="text" id="title" required></div>
                <div class="form-group">
                    <label for="contentImageFile">Imagem de Capa/Banner</label>
                    <input type="file" id="contentImageFile" accept="image/*">
                    <div class="image-preview" id="contentImagePreview"></div>
                </div>
                <div class="form-group">
                    <label for="contentType">Tipo de Conte√∫do</label>
                    <select id="contentType" onchange="toggleContentInput()">
                        <option value="iframe">iFrame (Gamma, etc.)</option>
                        <option value="html">C√≥digo HTML</option>
                        <option value="audio">√Åudio (Upload MP3)</option>
                    </select>
                </div>
                <div class="form-group" id="urlInput"><label for="contentUrl">URL (iFrame)</label><input type="url" id="contentUrl"></div>
                <div class="form-group" id="htmlInput" style="display: none;"><label for="contentHtml">C√≥digo HTML</label><textarea id="contentHtml"></textarea></div>
                <div class="form-group" id="audioUploadInput" style="display: none;">
                    <label for="audioFile">Ficheiro de √Åudio (MP3)</label>
                    <input type="file" id="audioFile" accept="audio/*">
                    <div class="image-preview" id="audioFilePreview"></div>
                    <input type="hidden" id="contentAudioUrl">
                </div>
                <div class="form-group"><label for="orderPosition">Ordem</label><input type="number" id="orderPosition" value="1" min="1"></div>
                <div class="form-group"><label><input type="checkbox" id="isActive" checked> Conte√∫do Ativo</label></div>
                <div class="button-group">
                    <button type="submit" class="btn" id="saveContentBtn">üíæ Guardar Conte√∫do</button>
                    <button type="button" class="btn btn-secondary" onclick="resetContentForm()">Limpar</button>
                </div>
            </form>
        </div>
        
        <div id="list-section" class="content-section">
            <h2>Listagem de Conte√∫dos</h2>
            <div class="form-group"><label for="filterModule">Filtrar por M√≥dulo</label><select id="filterModule" onchange="loadContents()"></select></div>
            <div class="content-list" id="contentList"></div>
        </div>

        <div id="submodules-section" class="content-section">
            <h2>Adicionar ou Editar Sub-M√≥dulos</h2>
            <form id="subModuleForm">
                <input type="hidden" id="editSubModuleId"><input type="hidden" id="subModuleImageUrl">
                <div class="form-group"><label for="parentModuleKey">M√≥dulo Pai</label><select id="parentModuleKey" required></select></div>
                <div class="form-group"><label for="subModuleName">Nome do Sub-M√≥dulo</label><input type="text" id="subModuleName" required></div>
                <div class="form-group">
                    <label for="subModuleImageFile">Imagem</label>
                    <input type="file" id="subModuleImageFile" accept="image/*">
                    <div class="image-preview" id="subModuleImagePreview"></div>
                </div>
                <div class="form-group"><label for="subModuleOrder">Ordem</label><input type="number" id="subModuleOrder" value="1" min="1" required></div>
                <div class="button-group">
                    <button type="submit" class="btn" id="saveSubModuleBtn">Adicionar Sub-M√≥dulo</button>
                    <button type="button" class="btn btn-secondary" onclick="resetSubModuleForm()">Limpar</button>
                </div>
            </form>
            <hr style="margin: 40px 0; border: 1px solid #eee;">
            <h3>Sub-M√≥dulos Atuais</h3>
            <div class="content-list" id="subModuleList"></div>
        </div>
        
        <div id="modules-section" class="content-section">
            <h2>Adicionar ou Editar M√≥dulos</h2>
            <form id="moduleForm">
                <input type="hidden" id="editModuleKey"><input type="hidden" id="moduleImageUrl">
                <div class="form-group"><label for="newModuleKey">Chave</label><input type="text" id="newModuleKey" required></div>
                <div class="form-group"><label for="newModuleName">Nome</label><input type="text" id="newModuleName" required></div>
                 <div class="form-group">
                    <label for="moduleImageFile">Imagem</label>
                    <input type="file" id="moduleImageFile" accept="image/*">
                    <div class="image-preview" id="moduleImagePreview"></div>
                </div>
                <div class="form-group"><label for="newModuleOrder">Ordem</label><input type="number" id="newModuleOrder" value="1" min="1" required></div>
                <div class="form-group"><label for="newModuleAccess">N√≠vel de Acesso</label><input type="text" id="newModuleAccess" value="basico" required></div>
                <div class="button-group">
                    <button type="submit" class="btn" id="saveModuleBtn">Adicionar M√≥dulo</button>
                    <button type="button" class="btn btn-secondary" onclick="resetModuleForm()">Limpar</button>
                </div>
            </form>
            <hr style="margin: 40px 0; border: 1px solid #eee;">
            <h3>M√≥dulos Atuais</h3>
            <div class="content-list" id="moduleList"></div>
        </div>

        <div id="feed-section" class="content-section">
            <h2>Adicionar ou Editar Post no Feed</h2>
            <form id="feedForm" style="margin-bottom: 30px;">
                <input type="hidden" id="editFeedId">
                <div class="form-group"><label for="feedTitle">T√≠tulo do Post</label><input type="text" id="feedTitle" required></div>
                <div class="form-group"><label for="feedContent">Conte√∫do</label><textarea id="feedContent" rows="5" required></textarea></div>
                <div class="form-group">
                    <label for="feedImageFile">Imagem (opcional)</label>
                    <input type="file" id="feedImageFile" accept="image/*">
                    <div class="image-preview" id="feedImagePreview"></div>
                    <input type="hidden" id="feedImageUrl">
                </div>
                <div class="form-group"><label><input type="checkbox" id="feedActive" checked> Post Ativo</label></div>
                <div class="button-group">
                    <button type="submit" class="btn" id="saveFeedBtn">üíæ Publicar Post</button>
                    <button type="button" class="btn btn-secondary" onclick="resetFeedForm()">Limpar</button>
                </div>
            </form>
            <hr style="margin: 40px 0; border: 1px solid #eee;">
            <h3>Posts Publicados</h3>
            <div id="feedList" class="content-list"></div>
        </div>

        <div id="community-section" class="content-section">
            <h2>Moderar Mensagens da Comunidade</h2>
            <div class="form-group">
                <label for="filterStatus">Filtrar por Status</label>
                <select id="filterStatus" onchange="loadCommunityMessages()">
                    <option value="pending">Pendentes</option>
                    <option value="approved">Aprovadas</option>
                    <option value="rejected">Rejeitadas</option>
                </select>
            </div>
            <div id="communityList" class="content-list"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://gvrnnfzflefecxqedgih.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cm5uZnpmbGVmZWN4cWVkZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NjE3MzIsImV4cCI6MjA3NDEzNzczMn0.kmvAFT7qlExTk2JQf5NjLB0sfwKaqb8RfxvdCbl8oXo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let modulesMap = new Map();
        let subModulesMap = new Map();
        let profilesMap = new Map();

        // --- FUN√á√ïES GLOBAIS E DE INICIALIZA√á√ÉO ---
        async function init() {
            const loginUrl = `${window.location.origin}/admin-login.html`;
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return window.location.href = loginUrl;
            const { data: profile } = await supabase.from('profiles').select('is_admin').eq('id', session.user.id).single();
            if (!profile || !profile.is_admin) { await supabase.auth.signOut(); return window.location.href = loginUrl; }
            document.getElementById('loading-view').style.display = 'none';
            document.querySelector('.admin-container').style.display = 'block';
            await loadInitialData();
            switchTab('add');
        }
        async function loadInitialData() {
            const [modulesRes, subModulesRes, profilesRes] = await Promise.all([
                supabase.from('modules').select('*').order('order_position'),
                supabase.from('sub_modules').select('*').order('order_position'),
                supabase.from('profiles').select('id, name, email')
            ]);
            if (modulesRes.data) {
                modulesMap.clear();
                modulesRes.data.forEach(m => modulesMap.set(m.key, m));
                updateModuleSelects(modulesRes.data);
            }
            if (subModulesRes.data) {
                subModulesMap.clear();
                subModulesRes.data.forEach(sm => subModulesMap.set(sm.id, sm));
            }
            if(profilesRes.data) {
                profilesMap.clear();
                profilesRes.data.forEach(p => profilesMap.set(p.id, p.name || p.email.split('@')[0]));
            }
        }
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none' );
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            const section = document.getElementById(`${tab}-section`);
            if (section) {
                section.style.display = 'block'; section.classList.add('active');
                if (tab === 'list') loadContents();
                else if (tab === 'modules') loadModules();
                else if (tab === 'submodules') loadSubModules();
                else if (tab === 'feed') loadFeedPosts();
                else if (tab === 'community') loadCommunityMessages();
            }
        }
        function showMessage(message, type) { const messageArea = document.getElementById('messageArea'); messageArea.innerHTML = `<div class="message ${type}">${message}</div>`; setTimeout(() => { messageArea.innerHTML = ''; }, 5000); }
        async function logout() { await supabase.auth.signOut(); window.location.href = `${window.location.origin}/admin-login.html`; }
        function slugify(text) { const a = '√†√°√¢√§√¶√£√•ƒÅƒÉƒÖ√ßƒáƒçƒëƒè√®√©√™√´ƒìƒóƒôƒõƒü«µ·∏ß√Æ√Ø√≠ƒ´ƒØ√¨≈Ç·∏ø√±≈Ñ«π≈à√¥√∂√≤√≥≈ì√∏≈ç√µ≈ë·πï≈ï≈ô√ü≈õ≈°≈ü»ô≈•»õ√ª√º√π√∫≈´«ò≈Ø≈±≈≥·∫É·∫ç√ø√Ω≈æ≈∫≈º¬∑/_,:;'; const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'; const p = new RegExp(a.split('').join('|'), 'g'); return text.toString().toLowerCase().replace(/\s+/g, '-').replace(p, c => b.charAt(a.indexOf(c))).replace(/&/g, '-and-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '') }
        async function uploadFile(fileInput, folder) { const file = fileInput.files[0]; if (!file) return { url: null, error: null }; const originalName = file.name.substring(0, file.name.lastIndexOf('.')); const extension = file.name.substring(file.name.lastIndexOf('.')); const safeName = slugify(originalName) + extension; const filePath = `${folder}/${Date.now()}-${safeName}`; const { error } = await supabase.storage.from('app-uploads').upload(filePath, file); if (error) return { url: null, error: `Erro no upload: ${error.message}` }; const { data } = supabase.storage.from('app-uploads').getPublicUrl(filePath); return { url: data.publicUrl, error: null }; }

        // --- GERENCIAMENTO DE CONTE√öDO ---
        document.getElementById('contentForm').addEventListener('submit', async (e) => { e.preventDefault(); const saveBtn = document.getElementById('saveContentBtn'); saveBtn.disabled = true; saveBtn.textContent = 'A guardar...'; try { let imageUrl = document.getElementById('imageUrl').value; if (document.getElementById('contentImageFile').files.length > 0) { saveBtn.textContent = 'A enviar imagem...'; const { url, error } = await uploadFile(document.getElementById('contentImageFile'), 'images'); if (error) throw new Error(error); imageUrl = url; } let audioUrl = document.getElementById('contentAudioUrl').value; if (document.getElementById('contentType').value === 'audio' && document.getElementById('audioFile').files.length > 0) { saveBtn.textContent = 'A enviar √°udio...'; const { url, error } = await uploadFile(document.getElementById('audioFile'), 'audios'); if (error) throw new Error(error); audioUrl = url; } saveBtn.textContent = 'A guardar...'; const editId = document.getElementById('editContentId').value; const formData = { sub_module_id: parseInt(document.getElementById('subModule').value), title: document.getElementById('title').value, image_url: imageUrl || null, content_type: document.getElementById('contentType').value, content_url: document.getElementById('contentType').value === 'audio' ? audioUrl : document.getElementById('contentUrl').value, content_html: document.getElementById('contentHtml').value || null, order_position: parseInt(document.getElementById('orderPosition').value), active: document.getElementById('isActive').checked, module_key: document.getElementById('module').value }; const { error } = editId ? await supabase.from('contents').update(formData).eq('id', editId) : await supabase.from('contents').insert([formData]); if (error) throw error; showMessage(`Conte√∫do ${editId ? 'atualizado' : 'guardado'}!`, 'success'); resetContentForm(); switchTab('list'); } catch (error) { showMessage(`Erro: ${error.message}`, 'error'); } finally { saveBtn.disabled = false; saveBtn.textContent = 'üíæ Guardar Conte√∫do'; } });
        function resetContentForm() { document.getElementById('contentForm').reset(); document.getElementById('editContentId').value = ''; document.getElementById('imageUrl').value = ''; document.getElementById('contentAudioUrl').value = ''; document.getElementById('contentImagePreview').innerHTML = ''; document.getElementById('audioFilePreview').innerHTML = ''; toggleContentInput(); updateSubModuleSelect(''); }
        async function editContent(id) { const { data, error } = await supabase.from('contents').select('*').eq('id', id).single(); if (error) return showMessage('Erro ao carregar conte√∫do.', 'error'); resetContentForm(); switchTab('add'); document.getElementById('editContentId').value = data.id; document.getElementById('title').value = data.title; document.getElementById('module').value = data.module_key; await updateSubModuleSelect(data.module_key, data.sub_module_id); document.getElementById('contentType').value = data.content_type; document.getElementById('orderPosition').value = data.order_position; document.getElementById('isActive').checked = data.active; document.getElementById('imageUrl').value = data.image_url; if (data.image_url) document.getElementById('contentImagePreview').innerHTML = `<span>Imagem atual:</span> <img src="${data.image_url}" alt="Preview">`; if (data.content_type === 'audio') { document.getElementById('contentAudioUrl').value = data.content_url; if(data.content_url) document.getElementById('audioFilePreview').innerHTML = `<span>√Åudio atual carregado.</span>`; } else { document.getElementById('contentUrl').value = data.content_url; } document.getElementById('contentHtml').value = data.content_html; toggleContentInput(); document.getElementById('saveContentBtn').textContent = 'üíæ Atualizar Conte√∫do'; }
        function toggleContentInput() { const type = document.getElementById('contentType').value; document.getElementById('urlInput').style.display = type === 'iframe' ? 'block' : 'none'; document.getElementById('htmlInput').style.display = type === 'html' ? 'block' : 'none'; document.getElementById('audioUploadInput').style.display = type === 'audio' ? 'block' : 'none'; }
        function updateModuleSelects(modules) { const selects = document.querySelectorAll('#module, #filterModule, #parentModuleKey'); selects.forEach(select => { const currentVal = select.value; let placeholder = select.id === 'filterModule' ? 'Todos os M√≥dulos' : 'Selecione...'; select.innerHTML = `<option value="">${placeholder}</option>`; (modules || []).forEach(mod => select.innerHTML += `<option value="${mod.key}">${mod.name}</option>`); select.value = currentVal; }); }
        async function updateSubModuleSelect(moduleKey, selectedId = null) { const subModuleSelect = document.getElementById('subModule'); subModuleSelect.innerHTML = '<option value="">A carregar...</option>'; if (!moduleKey) { subModuleSelect.innerHTML = '<option value="">Selecione um m√≥dulo</option>'; return; } const { data } = await supabase.from('sub_modules').select('id, name').eq('module_key', moduleKey).order('order_position'); subModuleSelect.innerHTML = '<option value="">Selecione o sub-m√≥dulo</option>'; data.forEach(sm => subModuleSelect.innerHTML += `<option value="${sm.id}">${sm.name}</option>`); if(selectedId) subModuleSelect.value = selectedId; }
        async function loadContents() { const listEl = document.getElementById('contentList'); listEl.innerHTML = '<div class="loading">A carregar...</div>'; let query = supabase.from('contents').select('*').order('order_position'); const filterModule = document.getElementById('filterModule').value; if (filterModule) query = query.eq('module_key', filterModule); const { data, error } = await query; if (error) return; displayContents(data); }
        function displayContents(contents) { const listEl = document.getElementById('contentList'); if (!contents || contents.length === 0) { listEl.innerHTML = '<p>Nenhum conte√∫do encontrado.</p>'; return; } listEl.innerHTML = contents.map(c => { const sm = subModulesMap.get(c.sub_module_id); const m = modulesMap.get(c.module_key); return `<div class="content-item"><div class="content-image" style="background-image: url('${c.image_url || 'https://placehold.co/80x80/e0e0e0/333?text=Img'}')"></div><div class="content-info"><div class="content-title">${c.title} <span class="status-badge ${c.active ? 'status-active' : 'status-inactive'}">${c.active ? 'Ativo' : 'Inativo'}</span></div><div class="content-module">${m?.name || '...'} ‚Üí ${sm?.name || '...'}</div></div><div class="content-actions"><button class="btn btn-small" onclick="editContent('${c.id}')">Editar</button><button class="btn btn-small btn-danger" onclick="deleteContent('${c.id}')">Excluir</button></div></div>`}).join(''); }
        async function deleteContent(id) { if (!confirm('Tem a certeza que deseja excluir este conte√∫do?')) return; const { error } = await supabase.from('contents').delete().eq('id', id); if (error) showMessage('Erro: ' + error.message, 'error'); else { showMessage('Conte√∫do exclu√≠do com sucesso!', 'success'); loadContents(); }}

        // --- GERENCIAMENTO DE SUB-M√ìDULOS (COM CORRE√á√ÉO) ---
        document.getElementById('subModuleForm').addEventListener('submit', async (e) => { e.preventDefault(); const saveBtn = document.getElementById('saveSubModuleBtn'); saveBtn.disabled = true; saveBtn.textContent = 'A guardar...'; try { let imageUrl = document.getElementById('subModuleImageUrl').value; if (document.getElementById('subModuleImageFile').files.length > 0) { saveBtn.textContent = 'A enviar imagem...'; const { url, error } = await uploadFile(document.getElementById('subModuleImageFile'), 'images'); if (error) throw new Error(error); imageUrl = url; } saveBtn.textContent = 'A guardar...'; const editId = document.getElementById('editSubModuleId').value; const formData = { module_key: document.getElementById('parentModuleKey').value, name: document.getElementById('subModuleName').value, image_url: imageUrl || null, order_position: parseInt(document.getElementById('subModuleOrder').value) }; const { error } = editId ? await supabase.from('sub_modules').update(formData).eq('id', editId) : await supabase.from('sub_modules').insert([formData]); if (error) throw error; showMessage(`Sub-m√≥dulo ${editId ? 'atualizado' : 'criado'}!`, 'success'); await loadInitialData(); resetSubModuleForm(); loadSubModules(); } catch (error) { showMessage(`Erro: ${error.message}`, 'error'); } finally { saveBtn.disabled = false; saveBtn.textContent = document.getElementById('editSubModuleId').value ? 'Atualizar Sub-M√≥dulo' : 'Adicionar Sub-M√≥dulo'; } });
        function resetSubModuleForm() { document.getElementById('subModuleForm').reset(); document.getElementById('editSubModuleId').value = ''; document.getElementById('subModuleImageUrl').value = ''; document.getElementById('subModuleImagePreview').innerHTML = ''; document.getElementById('saveSubModuleBtn').textContent = 'Adicionar Sub-M√≥dulo';}
        function editSubModule(id) {
            const sm = subModulesMap.get(parseInt(id)); // CORRE√á√ÉO APLICADA AQUI
            if (!sm) { console.error(`Sub-m√≥dulo com ID ${id} n√£o encontrado no map.`); return; }
            resetSubModuleForm(); 
            document.getElementById('editSubModuleId').value = sm.id; 
            document.getElementById('parentModuleKey').value = sm.module_key; 
            document.getElementById('subModuleName').value = sm.name; 
            document.getElementById('subModuleOrder').value = sm.order_position; 
            document.getElementById('subModuleImageUrl').value = sm.image_url; 
            if(sm.image_url) document.getElementById('subModuleImagePreview').innerHTML = `<span>Imagem atual:</span> <img src="${sm.image_url}" alt="Preview">`; 
            document.getElementById('saveSubModuleBtn').textContent = 'Atualizar Sub-M√≥dulo'; 
            window.scrollTo(0, 0); 
        }
        async function loadSubModules() { const listEl = document.getElementById('subModuleList'); listEl.innerHTML = '<div class="loading">A carregar...</div>'; const { data, error } = await supabase.from('sub_modules').select('*').order('order_position'); if (error) return; displaySubModules(data); }
        function displaySubModules(subModules) { const listEl = document.getElementById('subModuleList'); if (!subModules || subModules.length === 0) { listEl.innerHTML = '<p>Nenhum sub-m√≥dulo.</p>'; return; } listEl.innerHTML = subModules.map(sm => { const m = modulesMap.get(sm.module_key); return `<div class="content-item"><div class="content-image" style="background-image: url('${sm.image_url || 'https://placehold.co/80x80/e0e0e0/333?text=Img'}')"></div><div class="content-info"><div class="content-title">${sm.name}</div><div class="content-module">${m?.name || '...'}</div></div><div class="content-actions"><button class="btn btn-small" onclick="editSubModule('${sm.id}')">Editar</button><button class="btn btn-small btn-danger" onclick="deleteSubModule('${sm.id}')">Excluir</button></div></div>`}).join(''); }
        async function deleteSubModule(id) { if (!confirm('Excluir sub-m√≥dulo ir√° apagar todos os conte√∫dos dentro dele. Continuar?')) return; const { error } = await supabase.from('sub_modules').delete().eq('id', id); if (error) showMessage('Erro: ' + error.message, 'error'); else { showMessage('Sub-m√≥dulo exclu√≠do com sucesso!', 'success'); await loadInitialData(); loadSubModules(); }}
        
        // --- GERENCIAMENTO DE M√ìDULOS ---
        document.getElementById('moduleForm').addEventListener('submit', async (e) => { e.preventDefault(); const saveBtn = document.getElementById('saveModuleBtn'); saveBtn.disabled = true; saveBtn.textContent = 'A guardar...'; try { let imageUrl = document.getElementById('moduleImageUrl').value; if (document.getElementById('moduleImageFile').files.length > 0) { saveBtn.textContent = 'A enviar imagem...'; const { url, error } = await uploadFile(document.getElementById('moduleImageFile'), 'images'); if (error) throw new Error(error); imageUrl = url; } saveBtn.textContent = 'A guardar...'; const editKey = document.getElementById('editModuleKey').value; const formData = { key: document.getElementById('newModuleKey').value, name: document.getElementById('newModuleName').value, image_url: imageUrl || null, order_position: parseInt(document.getElementById('newModuleOrder').value), access_level: document.getElementById('newModuleAccess').value }; const { error } = editKey ? await supabase.from('modules').update(formData).eq('key', editKey) : await supabase.from('modules').insert([formData]); if (error) throw error; showMessage(`M√≥dulo ${editKey ? 'atualizado' : 'criado'}!`, 'success'); await loadInitialData(); resetModuleForm(); loadModules(); } catch (error) { showMessage(`Erro: ${error.message}`, 'error'); } finally { saveBtn.disabled = false; saveBtn.textContent = document.getElementById('editModuleKey').value ? 'Atualizar M√≥dulo' : 'Adicionar M√≥dulo'; } });
        function resetModuleForm() { document.getElementById('moduleForm').reset(); document.getElementById('editModuleKey').value = ''; document.getElementById('moduleImageUrl').value = ''; document.getElementById('newModuleKey').disabled = false; document.getElementById('moduleImagePreview').innerHTML = ''; document.getElementById('saveModuleBtn').textContent = 'Adicionar M√≥dulo';}
        function editModule(key) { const mod = modulesMap.get(key); if (!mod) return; resetModuleForm(); document.getElementById('editModuleKey').value = mod.key; document.getElementById('newModuleKey').value = mod.key; document.getElementById('newModuleKey').disabled = true; document.getElementById('newModuleName').value = mod.name; document.getElementById('newModuleOrder').value = mod.order_position; document.getElementById('newModuleAccess').value = mod.access_level; document.getElementById('moduleImageUrl').value = mod.image_url; if(mod.image_url) document.getElementById('moduleImagePreview').innerHTML = `<span>Imagem atual:</span> <img src="${mod.image_url}" alt="Preview">`; document.getElementById('saveModuleBtn').textContent = 'Atualizar M√≥dulo'; window.scrollTo(0, 0); }
        async function loadModules() { const listEl = document.getElementById('moduleList'); listEl.innerHTML = '<div class="loading">A carregar...</div>'; const modules = Array.from(modulesMap.values()).sort((a, b) => a.order_position - b.order_position); displayModules(modules); }
        function displayModules(modules) { const listEl = document.getElementById('moduleList'); if (!modules || modules.length === 0) { listEl.innerHTML = '<p>Nenhum m√≥dulo.</p>'; return; } listEl.innerHTML = modules.map(mod => `<div class="content-item"><div class="content-image" style="background-image: url('${mod.image_url || 'https://placehold.co/80x80/e0e0e0/333?text=Img'}')"></div><div class="content-info"><div class="content-title">${mod.name}</div><div class="content-module">${mod.key}</div></div><div class="content-actions"><button class="btn btn-small" onclick="editModule('${mod.key}')">Editar</button><button class="btn btn-small btn-danger" onclick="deleteModule('${mod.key}')">Excluir</button></div></div>`).join(''); }
        async function deleteModule(key) { if (!confirm('TEM A CERTEZA? Excluir um m√≥dulo ir√° apagar todos os seus sub-m√≥dulos e conte√∫dos.')) return; const { error } = await supabase.from('modules').delete().eq('key', key); if (error) showMessage('Erro: ' + error.message, 'error'); else { showMessage('M√≥dulo exclu√≠do com sucesso!', 'success'); await loadInitialData(); loadModules(); }}

        // --- GERENCIAMENTO DE FEED ---
        document.getElementById('feedForm').addEventListener('submit', async (e) => { e.preventDefault(); const saveBtn = document.getElementById('saveFeedBtn'); saveBtn.disabled = true; saveBtn.textContent = 'A guardar...'; try { let imageUrl = document.getElementById('feedImageUrl').value; if (document.getElementById('feedImageFile').files.length > 0) { saveBtn.textContent = 'A enviar imagem...'; const { url, error } = await uploadFile(document.getElementById('feedImageFile'), 'feed'); if (error) throw new Error(error); imageUrl = url; } saveBtn.textContent = 'A guardar...'; const editId = document.getElementById('editFeedId').value; const formData = { title: document.getElementById('feedTitle').value, content: document.getElementById('feedContent').value, image_url: imageUrl || null, active: document.getElementById('feedActive').checked }; const { error } = editId ? await supabase.from('feed_posts').update(formData).eq('id', editId) : await supabase.from('feed_posts').insert([formData]); if (error) throw error; showMessage(`Post ${editId ? 'atualizado' : 'publicado'} com sucesso!`, 'success'); resetFeedForm(); loadFeedPosts(); } catch (error) { showMessage(`Erro: ${error.message}`, 'error'); } finally { saveBtn.disabled = false; saveBtn.textContent = 'üíæ Publicar Post'; } });
        async function loadFeedPosts() { const listEl = document.getElementById('feedList'); listEl.innerHTML = '<div class="loading">A carregar...</div>'; const { data, error } = await supabase.from('feed_posts').select('*').order('created_at', { ascending: false }); if (error) { listEl.innerHTML = `<p style="color:red">Erro: ${error.message}</p>`; return; } displayFeedPosts(data); }
        function displayFeedPosts(posts) { const listEl = document.getElementById('feedList'); if (!posts || posts.length === 0) { listEl.innerHTML = '<p>Nenhum post no feed ainda.</p>'; return; } listEl.innerHTML = posts.map(post => `<div class="content-item">${post.image_url ? `<div class="content-image" style="background-image: url('${post.image_url}')"></div>` : ''}<div class="content-info"><div class="content-title">${post.title} <span class="status-badge ${post.active ? 'status-active' : 'status-inactive'}">${post.active ? 'Ativo' : 'Inativo'}</span></div><div class="content-module">Publicado em: ${new Date(post.created_at).toLocaleDateString('pt-BR')}</div></div><div class="content-actions"><button class="btn btn-small" onclick="editFeedPost('${post.id}')">‚úèÔ∏è Editar</button><button class="btn btn-small btn-danger" onclick="deleteFeedPost('${post.id}')">üóëÔ∏è Excluir</button></div></div>`).join(''); }
        async function editFeedPost(id) { const { data, error } = await supabase.from('feed_posts').select('*').eq('id', id).single(); if (error) return showMessage('Erro ao carregar post.', 'error'); resetFeedForm(); document.getElementById('editFeedId').value = data.id; document.getElementById('feedTitle').value = data.title; document.getElementById('feedContent').value = data.content; document.getElementById('feedActive').checked = data.active; document.getElementById('feedImageUrl').value = data.image_url; if(data.image_url) document.getElementById('feedImagePreview').innerHTML = `<span>Imagem atual:</span> <img src="${data.image_url}" alt="Preview">`; document.getElementById('saveFeedBtn').textContent = 'üíæ Atualizar Post'; window.scrollTo(0, 0); }
        function resetFeedForm() { document.getElementById('feedForm').reset(); document.getElementById('editFeedId').value = ''; document.getElementById('feedImageUrl').value = ''; document.getElementById('feedImagePreview').innerHTML = ''; document.getElementById('saveFeedBtn').textContent = 'üíæ Publicar Post'; }
        async function deleteFeedPost(id) { if (!confirm('Tem a certeza que deseja excluir este post?')) return; const { error } = await supabase.from('feed_posts').delete().eq('id', id); if (error) showMessage('Erro ao excluir: ' + error.message, 'error'); else { showMessage('Post exclu√≠do com sucesso!', 'success'); loadFeedPosts(); } }

        // --- MODERA√á√ÉO DE COMUNIDADE ---
        async function loadCommunityMessages() { const listEl = document.getElementById('communityList'); listEl.innerHTML = '<div class="loading">A carregar...</div>'; const filter = document.getElementById('filterStatus').value; const { data, error } = await supabase.from('community_posts').select('*').eq('status', filter).order('created_at', { ascending: false }); if (error) { listEl.innerHTML = `<p style="color:red;">Erro: ${error.message}</p>`; return; } displayCommunityMessages(data); }
        function displayCommunityMessages(messages) { const listEl = document.getElementById('communityList'); if (!messages || messages.length === 0) { listEl.innerHTML = '<p>Nenhuma mensagem encontrada para este status.</p>'; return; } listEl.innerHTML = messages.map(msg => { const author = profilesMap.get(msg.user_id) || 'An√≥nimo'; const statusClass = { pending: 'status-pending', approved: 'status-approved', rejected: 'status-rejected'}[msg.status]; return `<div class="content-item"><div class="content-info"><div class="content-title">${author} <span class="status-badge ${statusClass}">${msg.status}</span></div><p style="margin: 10px 0; background: #fff; border-radius: 5px; border: 1px solid #ddd; padding: 10px;">${msg.content}</p><div class="content-module">Data: ${new Date(msg.created_at).toLocaleString('pt-BR')}</div></div><div class="content-actions">${msg.status !== 'approved' ? `<button class="btn btn-small" onclick="updateMessageStatus('${msg.id}', 'approved')">‚úÖ Aprovar</button>` : ''}${msg.status !== 'rejected' ? `<button class="btn btn-small btn-danger" onclick="updateMessageStatus('${msg.id}', 'rejected')">‚ùå Rejeitar</button>` : ''}<button class="btn btn-small btn-danger" style="margin-left: 10px;" onclick="deleteMessage('${msg.id}')">üóëÔ∏è Excluir</button></div></div>`}).join(''); }
        async function updateMessageStatus(id, status) { const { error } = await supabase.from('community_posts').update({ status: status, updated_at: new Date().toISOString() }).eq('id', id); if (error) showMessage('Erro ao atualizar status: ' + error.message, 'error'); else { showMessage(`Mensagem ${status === 'approved' ? 'aprovada' : 'rejeitada'}!`, 'success'); loadCommunityMessages(); } }
        async function deleteMessage(id) { if (!confirm('Tem a certeza que deseja excluir esta mensagem permanentemente?')) return; const { error } = await supabase.from('community_posts').delete().eq('id', id); if (error) showMessage('Erro ao excluir: ' + error.message, 'error'); else { showMessage('Mensagem exclu√≠da com sucesso!', 'success'); loadCommunityMessages(); } }

        // --- EVENT LISTENERS E INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', init);
        Object.assign(window, { 
            logout, switchTab, updateModuleSelects, updateSubModuleSelect, toggleContentInput, 
            resetContentForm, editContent, deleteContent, 
            resetSubModuleForm, editSubModule, deleteSubModule, 
            resetModuleForm, editModule, deleteModule,
            loadContents, loadModules, loadSubModules,
            loadFeedPosts, resetFeedForm, editFeedPost, deleteFeedPost,
            loadCommunityMessages, updateMessageStatus, deleteMessage
        });
    </script>
</body>
</html>
}
Quero finalizar o projeto. Para isso quero excluir a se√ß√£o ‚ÄúGerir Feed‚Äù e ‚ÄúModerar Comunidade‚Äù, pois no momento n√£o vou precisar.
